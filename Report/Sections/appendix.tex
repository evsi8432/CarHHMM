% !TeX root = ../main.tex

\addcontentsline{toc}{section}{Appendices}
\renewcommand*{\thesubsection}{\Alph{subsection}}

\begin{proof}{Proof of Theorem 1}{}
Combining equation (\ref{eqn:CarHMM_to_OU}) with equation (\ref{eqn:OU_sol}) gives:
%
\begin{align*}
\left(Y_{s \Delta t} | X_{(s-1)\Delta t} = i^* \right) \sim \mathcal{N}\left((1-\phi^{(i^*)}) \mu^{(i^*)} + \phi^{(i^*)} Y_{(s-1) \Delta t}, \enspace \sigma^{2(i^*)} \right),\\
s = 1, \ldots, T-1
\end{align*}
%
If $X_t$ follows a Markov chain with transitions at the observation times, then the behavioural state $X_t$ does not change between observations and we can re-index $Y_{(s-1) \Delta t} = Y'_s$ and $X_{(s-2)\Delta t: (s-1) \Delta t} = X'_s$ for $s = 2,\ldots T$, yielding the desired result:

\begin{align*}
\left(Y'_s| X'_s = i^* \right) \sim \mathcal{N}\left((1-\phi^{(i^*)}) \mu^{(i^*)} + \phi^{(i^*)} Y'_{s-1}, \enspace \sigma^{2(i^*)} \right)\\
s = 2, \ldots, T
\end{align*}
%
$X'$ follows a Markov chain, and the distribution of $(Y'_s|X'_s,Y'_{s+1})$ is consistent with that of a CarHMM with normal emission distributions.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{proof}{Description of simulated data}{}

$\hat{Y}^*_{t,t^*}$ was simulated using the following procedure. The $k^{th}$ Fourier mode of $\hat{Y}^*_{t,t^*}$ is denoted as $\hat{Y}^{*(k)}_{t,t^*}$:

\begin{align}
	(\hat{Y}^{*(0)}_{t,0}|X^*_{t,0} = i^*) &\sim \mathcal{N} \left(0, \sigma^{*(i^*)} \right) & \nonumber \\
	%
	(\hat{Y}^{*(0)}_{t,t^*}|X^*_{t,t^*} = i^*) &\sim \mathcal{N} \left(\phi^{*(i^*)} * \hat{Y}^{*(0)}_{t,t^*-1}, \sigma^{*(i^*)} \right), & t^* = 1,2,\ldots, \lfloor Y_t/2 \rfloor \label{eqn:y_hat0} \\
	%
	\hat{Y}^{*(k)}_{t,t^*} &= a_{t,t^*}^{(k)} i\sqrt{b^{(k)}_{t,t^*}}, & k = 1,\ldots,49 \nonumber
\end{align}

\begin{align*}
    a_{t,t^*}^{(k)} &\sim  \left\{\begin{array}{lr}
	-1 & \quad w.p. \enspace 1/2 \\
	1  & \quad w.p. \enspace 1/2
	\end{array}\right. \\
	%
	(b^{(k)}_{t,t^*}|X^*_{t,t^*}  = 1) &\sim {\rm{Gamma}}(5/k^2, 1) \\
	%
	(b^{(k)}_{t,t^*}|X^*_{t,t^*} = 2) &\sim \left\{\begin{array}{lr}
	{\rm{Gamma}}(5/k^2, 1), \quad & k \notin \{1,2\} \\
	{\rm{Gamma}}(250,1), & k = 1 \\
	{\rm{Gamma}}(50,1), & k = 2
	\end{array}\right. 
\end{align*}

\begin{align*}
    \hat{Y}^{*(50)}_{t,t^*} &= 0 & \\
	%
	\hat{Y}^{*(k)}_{t,t^*}  &= -\hat{Y}^{*(100-k)}_{t,t^*}, & \qquad k = 51,\ldots,99
\end{align*}

$Y^*_{t,t^*,1:100}$ was set using the inverse discrete Fourier transform of $\hat{Y}^*_{t,t^*}$:

$$Y^*_{t,t^*,1:100} = IDFT\left(\hat{Y}^*_{t,t^*}\right), \qquad t^* = 1,\ldots,\lfloor Y_t/2 \rfloor$$

$\hat{Y}^*_{t,t^*}$ is anti-symmetric about $\hat{Y}^{*(50)}_{t,t^*}$ so that its inverse Fourier transform is real-valued. $\hat{Y}^{*(k)}_{t,t^*}$ also decays like $1/k$ so that $Y^*_{t,t^*}$ remains continuous within a 2-second window. $Y^*_{t,t^*}$ is not continuous \textit{between} windows, but the jump discontinuities are not very severe since $\hat{Y}^{*(0)}_{t,t^*}$ and $\hat{Y}^{*(0)}_{t,t^*+1}$ are highly correlated. See (fig. \ref{fig:sim_data}) for details. 

From here it is straightforward to calculate both $Z^{*(1)}$ and $Z^{*(2)}$. We pick $\tilde{\omega} = 10$ periods per window, or 5 hertz. To find the distribution of $Z^{*(1)}_{t,t^*} = \mathcal{R}\left(\hat{Y}^{(0)}_{t,t^*}\right)$, use (eqn \ref{eqn:y_hat0}):
%
$$\left(Z^{*(1)}_{t,t^*} | X^*_{t,t^*} = i^* \right) = \left(\mathcal{R}\left(\hat{Y}^{(0)}_{t,t^*}\right) | X^*_{t,t^*} = i^* \right) \sim \mathcal{N} \left(\phi^{*(i^*)} * Z^{*(1)}_{t,t^*-1}, \sigma^{*(i^*)} \right)$$
%
$Z^{*(2)}_{t,t^*}$ is the sum of Gamma-distributed random variables with the same scale parameter, so the distribution of $Z^{*(2)}_{t,t^*}$ is also a Gamma distribution:
%
$$Z^{*(2)}_{t,t^*} = \sum_{k=1}^{10} b^{(k)}_{t,t^*}$$
$$\left(Z^{*(2)}_{t,t^*}|X^*_{t,t^*} = 1\right) \sim {\rm{Gamma}}\left(\alpha = \sum_{k=1}^{10} 5/k^2 = 10.10, \beta = 1.00 \right)$$
$$\left(Z^{*(2)}_{t,t^*}|X^*_{t,t^*} = 1\right) \sim {\rm{Gamma}}\left(\alpha = 300 + \sum_{k=3}^{10} 5/k^2 = 305.94 , \beta = 1.00 \right)$$
\end{proof}

\begin{proof}{Likelihood of Simulation study model}{}

The overall likelihood of the CarHHMM-DFT model is as follows:
%
$$\calL_{\text{CarHHMM-DFT}}(y,z^*;\Theta,\Theta^*,\Gamma,\Gamma^*) = \delta P(y_1,z_1^*;\Theta,\Theta^*,\Gamma^*) \prod_{t=2}^T \Gamma P(y_t,z_t^*;\Theta,\Theta^*,\Gamma^*) \mathbf{1}_N$$
%
where:
%
\begin{align*}
P(y_t,z_t^*;\Theta,\Theta^*,\Gamma^*)  = \text{diag}\Big[&f^{(1)}(y_t;\Theta^{(i)})\calL_{\text{CarHMM-DFT}}\left(z_t^*;\Theta^{*(1)},\Gamma^{*(1)}\right), \ldots , \\
&f^{(N)}(y_t;\Theta^{(i)})\calL_{\text{CarHMM-DFT}}\left(z_t^*;\Theta^{*(N)},\Gamma^{*(N)}\right) \Big]
\end{align*}
%
$f^{(i)}(y_t;\Theta^{(i)})$ is the emission distribution of the dive duration $y_t$ conditioned on the fact that $X_t = i$.

$\calL_{\text{CarHMM-DFT}}$ corresponds to the fine-scale chain:
%
$$\calL_{\text{CarHMM-DFT}}\left(z_t^*;\Theta^{*(i)},\Gamma^{*(i)}\right) = \delta^{*(i)} \prod_{t=2}^T \Gamma^{*(i)} P(z^*_{t,t^*}|z^*_{t,t^*-1};\Theta^{*(i^*)}) \mathbf{1}_N$$
%
where $P(z^*_{t,t^*}|z^*_{t,t^*-1};\Theta^{*(i)})$ is an $N^* \times N^*$ diagonal matrix with $i^*i^*$th entry equal to $f^{(i,i^*)}(z^*_{t,t^*}|z^*_{t,t^*-1}; \theta^{*(i,i^*)})$.
%
$f^{(i,i^*)}(z^*_{t,t^*}|z^*_{t,t^*-1}; \theta^{*(i,i^*)})$ is the emission distribution of $Z^*_{t,t^*}$ conditioned on the fact that $X^*_{t,t^*} = i^*$ and $Z^*_{t,t^*-1}$.

\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iffalse


\subsection{Dimension Reduction on $\hat{Y_t^*}$}

First, we simply use down-sampling and only record every $w^{th}$ time step of $\hat{Y}_t^*$. This both reduces the space of $\hat{Y}_t^*$ to $\mathbb{C}^{\lfloor t^*_t / w \rfloor \times w}$ and ensures that none of the sliding windows overlap when taking the STFT. This is important because HMMs assume temporal independence between observations. Next, the dimension of $\hat{Y}_t^*$ can be cut in half by recognizing that the $Y_t^*$ is real-valued, and therefore $\hat{Y}_{t,k}^*$ is equal to the complex-congugate of $\hat{Y}_{t,w-k-1}^*$. Finally, by Parseval's Thereom we have that:

$$\sum_{n = 0}^{w-1} |Y^*_{t+n}|^2 = \sum_{n = 0}^{w-1} |\hat{Y}^*_{t,n}|^2$$

\subsection{Equivalency of CarHMM and one-dimensional state-switching Ornstein-Uhlenbeck process}

If it is the case that (1) the underlying behavioral state of the continuous-time model must follow a Markov chain rather than a Markov process, and (2) the emission distributions of the CarHMM are gaussian, then the CarHMM and the state-switching continuous model are equivalent. This allows the theoretically grounded continuous-time state-switching model to be used in the computational convieneint HMM (and therefore HHMM) framework. In addition, it gives new intpretation to the learned parameters of the CarHMM in the context of an Ornstein-Uhlenbeck process.

A one-dimensional state-switching Ornstein-Uhlenbeck process $y^*$ is the solution to the following stochastic differential equation:
%
$$dy^*_t = \beta_{x^*_t}(\gamma_{x^*_t} - y^*_t)dt + \omega_{x^*_t} dW_t$$
%
where $x^*_t$ is the fine-scale behavior of the animal at time $t$, $\beta_{x^*_t}$ relates to rate at which the process returns to its mean value, $\gamma_{x^*_t}$ is the long-term mean value of the process, $\omega_{x^*_t}$ is related to short-term variance, and $W$ is a Wiener process. As before, $x^*_t$ is described by an unobserved Markov process. The solution to this equation is known to be the following \cite{Michelot:2019}:
\begin{align*}
y^*_{t+\delta} \sim \mathcal{N}\left((1-e^{-\beta_{x^*_t}\delta})\gamma_{x^*_t} + e^{-\beta_{x^*_t}\delta} y^*_t,\quad \frac{\omega_{x^*_t}^2}{2\beta_{x^*_t}} (1-e^{-2\beta_{x^*_t}\delta})\right)
\end{align*}
Now, suppose that $\delta$ is constant for all observations, as is the case for hidden Markov models. In addition, introduce the following transformations:
\begin{align*}
\mu_{x^*_t} = \gamma_{x^*_t}, \qquad \phi_{x^*_t} = e^{-\beta_{x^*_t}\delta}, \qquad \sigma^2_{x^*_t} = \frac{\omega_{x^*_t}^2}{2\beta_{x^*_t}} (1-e^{-2\beta_{x^*_t}\delta})
\end{align*}
Then, we have the following:
\begin{align*}
y^*_{t+\delta} \sim \mathcal{N}\left((1-\phi_{x^*_t})\mu_{x^*_t} + \phi_{x^*_t} y^*_t,\quad \sigma_{x^*_t}^2 \right)
\end{align*}
%
If $\delta$ is fixed and $x^*_t$ is adjusted to follow a Markov chain rather than a Markov process, then this model is equivalent to the CarHMM with normal emission probabilities. Note that all of the parameter transformations above are one-to-one, so it is easy to go from the CarHMM to the continuous model and back again. This allows for the principled construction of the continuous-time model to be combined with the computational convenience of the CarHMM.

\fi
