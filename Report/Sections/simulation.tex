% !TeX root = ../main.tex

%\section{Simulation Study}

We based our simulation study on the acceleration data of a killer whale's dive sequence. The parameters used to generate the data are loosely based on those learned from the case study in Section \ref{sec:case_study}. We fit four separate models to the simulated data and compare their accuracy.

\subsection{Data Simulation}

Five hundred separate sequences of 100 killer whale dives were simulated according to an HMM, where the hidden Markov chain $X$ was a collection of dive types and the observations $Y$ were the corresponding dive durations (in seconds). Each dive could be one of $N=2$ dive types, and the duration of the $t^{th}$ dive, $Y_t$, followed a gamma distribution whose parameters $\theta^{(i)}$ were dependent on the dive type $X_t = i$. We parameterize the gamma distribution by its mean and variance:
%
$$\Gamma = \begin{pmatrix} 0.5 & 0.5 \\ 0.5 & 0.5 \end{pmatrix}, \qquad \delta =  \begin{pmatrix} 0.5 & 0.5 \end{pmatrix},$$
$$Y_t|X_t \sim \rm{Gamma},$$
\begin{align*}
	&\bbE(Y_t|X_t = 1) = 15 s, &\bbE(Y_t|X_t = 2) = 60 s, \\
	%
	&\bbV(Y_t|X_t = 1) = 25 s^2, &\bbV(Y_t|X_t = 2) = 100 s^2.
\end{align*}
%
Once the dive durations were calculated for all 100 dives, dive $t$ was broken into a sequence of $T^*_t = \lfloor Y_t/2 \rfloor$ two-second segments, which made up a second fine-scale hidden Markov model. The last $Y_t - 2\lfloor Y_t/2 \rfloor$ seconds of the dive were discarded. Each two-second segment was assigned one of $N^*=2$ behaviours (active swimming or passive gliding) according to a fine-scale Markov chain $X^*_t \equiv \left(X^*_{t,1}, \ldots, X^*_{t,T^*_t} \right)$. The probability transition matrices for these fine-scale Markov chains were set as
%
$$\Gamma^{*(1)} = \begin{pmatrix} 0.5 & 0.5 \\ 0.1 & 0.9 \end{pmatrix}, \qquad \Gamma^{*(2)} = \begin{pmatrix} 0.8 & 0.2 \\ 0.3 & 0.7 \end{pmatrix},$$ 
%
where $\Gamma^{*(1)}$ was used for dives where $X_t = 1$ and $\Gamma^{*(2)}$ was used for dives where $X_t = 2$. 

Each two-second sub-dive window had 100 associated acceleration readings, $Y^*_{t,t^*} \equiv \left(Y^*_{t,t^*,1}, \ldots, Y^*_{t,t^*,100}\right)$. To accurately recreate active swimming versus passive gliding on the fine-scale Markov chain, the DFT of each two-second segment $\hat Y^*_{t,t^*}$ was simulated such that $Z^{*(1)}_{t,t^*}$ and $Z^{*(2)}_{t,t^*}$ (see Eq. \ref{eqn:z}) have the following distributions: 

\begin{gather*}
    \left(Z^{*(1)}_{t,t^*} | Z^{*(1)}_{t,t^*-1}, X^*_{t,t^*} = 1 \right) \sim \mathcal{N} \left(\phi^{*(1)}Z^{*(1)}_{t,t^*-1} + (1-\phi^{*(1)})\mu^{*(1)}, (\sigma^{*(1)})^2 \right) \\
    %
    \left(Z^{*(1)}_{t,t^*} | Z^{*(1)}_{t,t^*-1}, X^*_{t,t^*} = 2 \right) \sim \mathcal{N} \left(\phi^{*(2)}Z^{*(1)}_{t,t^*-1} + (1-\phi^{*(2)})\mu^{*(2)}, (\sigma^{*(2)})^2 \right) \\
    %
    \mu^{*(1)} = 0.0,\enspace \sigma^{*(1)} = 0.05,\enspace \phi^{*(1)} = 0.99 \\
    %
    \mu^{*(2)} = 0.0,\enspace \sigma^{*(2)} = 0.1,\enspace \phi^{*(2)} = 0.95 \\\\
    %
    \left(Z^{*(2)}_{t,t^*} | X^*_{t,t^*} = 1\right) \sim {\rm{Gamma}}\left(\alpha^{*(1)}, \beta^{*(1)} \right) \\
    %
    \left(Z^{*(2)}_{t,t^*} | X^*_{t,t^*} = 2\right) \sim {\rm{Gamma}}\left(\alpha^{*(2)}, \beta^{*(2)} \right) \\
    %
    \alpha^{*(1)} = 10.10, \enspace \enspace \beta^{*(1)} = 1.00 \\
    %
    \alpha^{*(2)} = 305.94, \enspace \enspace \beta^{*(2)} = 1.00
\end{gather*}
%
Sub-dive behavior 1 corresponds to passive gliding while sub-dive behaviour 2 corresponds to active swimming with a dominant frequency of $\frac{1}{2}s^{-1}$. Sub-dive behaviors 1 and 2 are the same for both dive types. See the appendix for more details regarding procedure for simulating $\hat Y^*$ and $Y^*$ such that $Z^*$ has the preceding distribution. Figure \ref{fig:sim_data} shows the first 5 dives of one simulated data set.

\subsection{Model Formulation}
\label{subsec:model_structure}

The building blocks from the previous section were used to build a well-specified model for this simulated data. Specifically, we used a hierarchical HMM where the sequence of dive durations $Y$ was modeled using a simple HMM, and the fine-scale process $Z^*$ was modeled using a HMM-DFT with explicit auto-correlation in $Z^{*(1)}$. Naturally, we refer to this model as the \textbf{CarHHMM-DFT}. Figure \ref{fig:CarHHMM-DFT} shows a graphical representation of this model. 

On the coarse scale, the dive types follow a Markov chain with $N=2$ possible states and unknown probability transition matrix $\Gamma$. The duration of a dive follows a gamma distribution which depends upon the dive type and unknown parameters $\Theta = \{\{\mu^{(1)},\sigma^{(1)}\},\{\mu^{(2)},\sigma^{(2)}\}\}$.

On the fine scale, the sub-dive behavior of each two-second window comprises a Markov chain with $N^*=2$ possible states and unknown probability transition matrices $\Gamma^{*(1)}$ and $\Gamma^{*(2)}$, depending upon the dive type. Each two-second window is summarized by the observations $Z^{*(1)}_{t,t^*}$ and $Z^{*(2)}_{t,t^*}$. The distribution of $Z^{*(1)}_{t,t^*}$ is Normal and its parameters depend upon the sub-dive behavior $X^*_{t,t^*}$ and $Z^{*(1)}_{t,t^*-1}$. In particular:

$$\mathbb{E}(Z^{*(1)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \phi_1^{*(i)}z + (1-\phi_1^{*(i)}) \mu_1^{*(i)}$$
$$\mathbb{V}(Z^{*(1)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \left(\sigma_1^{*(i)}\right)^2.$$
%
The distribution of $Z^{*(2)}_{t,t^*}$ is gamma and its parameters depend upon only $X^*_{t,t^*}$ (not $Z^{*(2)}_{t,t^*-1}$):
%
$$\mathbb{E}(Z^{*(2)}_{t,t^*}|Z^{*(2)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \mu_2^{*(i)}$$
$$\mathbb{V}(Z^{*(2)}_{t,t^*}|Z^{*(2)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \left(\sigma_2^{*(i)}\right)^2.$$
%
None of the fine-scale emission distributions depend upon dive type. In total the parameters to estimate are
%
\begin{gather*}
    \Gamma, \qquad \Gamma^{*} = \{\Gamma^{*(1)},\Gamma^{*(2)}\} \qquad \text{(probability transition matrices)}, \\
    %
    \Theta = \{\{\mu^{(1)},\sigma^{(1)}\},\{\mu^{(2)},\sigma^{(2)}\}\} \qquad \text{(coarse-scale emission parameters), and} \\
    %
    \Theta^* = \{\Theta^{*(1)},\Theta^{*(2)}\}  \qquad \text{(fine-scale emission parameters), where} \\
    %
    \Theta^{*(i)} =  \{\{\mu_1^{*(i)},\sigma_1^{*(i)},\phi_1^{*(i)}\},\{\mu_2^{*(i)},\sigma_2^{*(i)}\}\} \qquad \text{(}Z^{*(1)} \text{ and } Z^{*(2)} \text{ parameters).}
\end{gather*}
%
The likelihood of this model is still easy to calculate using the forward algorithm, and it can be maximized with respect to the parameters above. See the appendix for details of likelihood evaluation. Figure \ref{fig:CarHHMM-DFT} shows the corresponding graphical model.

Four different models were fit to the simulated data sets:
\begin{enumerate}
    \item A \textbf{CarHHMM-DFT} as described above.
    \item An \textbf{HHMM-DFT}, which is similar to the CarHHMM-DFT, but with no modeled auto-correlation \big(i.e. $\phi_1^{*(i)} = 0$ for $i = 1,2$\big).
    \item A \textbf{CarHHMM}, which is also similar to the CarHHMM-DFT, but without the Fourier sums $(Z^{*(2)})$ as an observation \big(i.e $\Theta^{*(i)} = \{\mu_1^{(i)},\sigma_1^{(i)},\phi_1^{(i)}\}$, $i = 1,2$\big).
    \item A \textbf{CarHMM-DFT}, which is again similar to the CarHHMM-DFT, but with $N=1$ instead of $N=2$ on the coarse scale. This is equivalent to loosing the coarse level of the hierarchical structure, as there is only one dive type.
\end{enumerate}
%
Each of the last three models leaves out one important aspect of the full CarHHMM-DFT. The CarHMM-DFT lacks a hierarchical structure, the HHMM-DFT is missing auto-correlation within the fine-scale observations, and the CarHHMM does not have access to the Fourier transform sums $(Z^{*(2)})$ as observations. 

All models were run on the Cedar Compute Canada cluster with 1 CPU and 4 GB of dedicated memory per model.

\subsection{Simulation Results}

%%% 

As expected, the full CarHHMM-DFT was the best-performing model. It was able to decode the fine-scale hidden states of the process almost perfectly (mean error $< 10^{-12}$ for all simulations) and decode the hidden dive types with an average accuracy of $94 \pm 3 \%$, where $\pm$ refers to the standard deviation across simulations (see Table \ref{table:accuracy}). All parameter estimates have biases which are at least approximately one order of magnitude smaller than the associated standard error, which is consistent with a sample size of 500 (section S-1.2, tables 2-5). One exception is for estimates of $\hat \sigma$, which were regularly underestimated. For dive duration $(Y_t)$ this finding is consistent with properties of MLEs for standard deviation, especially with a small sample size. For acceleration $(Z^{*(1)})$ this is likely due to over-fitting the auto-correlation parameter $\phi$. The Fourier sums $(Z^{*(2)})$ show no significant bias in $\hat \sigma^*_2$. The empirical standard error of all parameters estimates ($\hat \Theta$, $\hat \Gamma$, $\hat \Theta^*$, $\hat \Gamma^*$) were well-approximated by the inverse of the observed fisher information matrix (section S-1.2, tables 2-5). One exception is $\hat \Theta$, whose standard errors were slightly underestimated using the observed fisher information matrix. 
%The empirical standard error of $\hat \mu_2$ was 8.5, while the estimate of standard error using the observed Fisher information was 5.8. 
See Section S-1.2, tables 2-5 for more information.

The HHMM-DFT performed almost identically to the CarHHMM-DFT in most respects, including its decoding accuracy and parameter bias. 
%- it had very low error for the fine-scale hidden states and $\approx 94\%$ accuracy on the dive types (see Table \ref{table:accuracy}). In addition, the standard errors of the parameter estimates were comparable to those of the CarHHMM-DFT. The estimates of standard error using the observed Fisher information were also comparable to the CarHHMM-DFT. 
The HHMM-DFT \textit{did} differ from the CarHHMM-DFT in its estimate of the standard deviation of acceleration, $\hat \sigma_1^*$. For both sub-dive states, $\hat \sigma_1^*$ greatly overestimated the true standard deviation. In particular, $\bar \hat \sigma_1^{*(1)} = 0.248$ and $\bar \hat \sigma_1^{*(2)} = 0.242$, but $\sigma_1^{*(1)} = 0.05$ and $\sigma_1^{*(2)} = 0.1$. in addition, the empirical standard error of both $\hat \mu_1^*$ and $\hat \sigma_1^*$ was much larger than the estimates of standard error using the observed fisher information (see Section S-1.2, Table 3). This implies that parameter uncertainty can be underestimated when auto-correlation is ignored.

The CarHHMM was the worst-performing model in terms of decoding accuracy, with an accuracy of $89 \pm 2\%$ when determining sub-dive behavior and an accuracy of $91 \pm 3\%$ when determining dive types. It was much more likely to misclassify sub-dive behavior 1 than sub-dive behavior 2 (see Section S-1.2, Table 1). It was also the worst model in terms of parameter estimates, in part due to its relatively poor decoding accuracy. $\hat \Theta^{*(2)}$ and $\hat \Gamma^{*(2)}$ in particular were poor estimates of the true parameters (see Section S-1.1.3).

Finally, the CarHMM-DFT was comparable to the CarHHMM-DFT in terms of decoding accuracy, parameter bias, and parameter standard error for the fine-scale observations. In addition, the time required to fit the CarHHMM was approximately 1/5 that of the other models. However, it lacked any hierarchical structure, so it was unable to decode the coarse-scale dive types. The CarHMM-DFT still did fit a gamma distribution to the dive duration of \textit{all} dives. The parameter estimates $\hat \mu$ and $\hat \sigma$ are highly correlated, and $\hat \sigma$ is a significant underestimate by $\approx$ 5 seconds.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% EVERYTHING BELOW HERE IS OLD AND I THINK IT IS BAD. THE STUFF ABOVE IS MUCH BETTER.


\iffalse
%%% Accuracy %%%
Each model was able to decode the fine-scale hidden states of the process almost perfectly except for the CarHHMM, whose accuracy was 89\% (Table \ref{table:accuracy}). The lower accuracy of the CarHHMM (i.e. model without $Z^{*(2)}$)  can be attributed to the higher fine-scale states variation in the distribution of $Z^{*(2)}$ compared to $Z^{*(1)}$. For the coarse-scale hidden states, the CarHMM-DFT lacked a hierarchical structure and could not make coarse-scale predictions. All three other models achieved an accuracy of approximately 90\% (Table \ref{table:accuracy}), with the CarHHMM slightly more likely to categorize a dive as dive type 2 than the other models (Fig ? or Sup Table ? that give quantitative info on this). Figure \ref{fig:acc} shows the decoded state probabilities for both the fine- and coarse- scales for one of the simulation run.

%%% dive duration %%%
For the emission distributions of dive duration, Figure \ref{fig:MLE_dist} shows the empirical joint density of $\hat \mu$ and $\hat \sigma$ for the CarHHMM-DFT.

Estimates of standard error using the observed Fisher information tended to be negatively biased due to correlation between $\hat \mu$ and $\hat \sigma$. In addition, $\hat \sigma$ tends to be an underestimate of $\sigma$ for all models and dive types. This finding is consistent with properties of MLEs for standard deviation, especially with a small sample size. In particular, the CarHMM-DFT model is not well specified one the coarse-scale and severely underestimates $\sigma$. %This is likely due to the fact that dive duration follows a mixture of gammas rather than a gamma distribution, and the CarHMM does not have the machinery to capture this fact. 
A full table of parameter estimates for all models is shown in the supplementary material.


%%% Acceleration %%%
For acceleration ($Z^{*(1)}$), both the CarHMM-DFT and the CarHHMM-DFT regularly converged to the correct parameters with very little standard error. However, the estimated standard error based on the observed Fisher information regularly overestimated the empirical standard error of $\hat \mu$ for both of these models. 
%This likely is due to the very large auto-correlation terms ($\phi^{(1)} = 0.99$ and $\phi^{(2)} = 0.95$) since as $\phi \to 1$, the value of $\mu$ does not matter in the likelihood evaluation as $\phi \to 1$ implies that $\mathbb{E}(Z^{*(1)}_{t,s^*}) = \phi*(Z^{*(1)}_{t,s^*-1}) + (1-\phi)\mu \to Z^{*(1)}_{t,s^*-1}$. 
The HHMM-DFT regularly overestimates the variance $Z^{*(1)}$ since it does not incorporate auto-correlation into the emission distribution of $Z^{*(1)}$. The CarHHMM has large biases in many of its parameter estimates, especially in sub-dive state 2. 
%because it sees the ``wigliness" of the acceleration data as raw acceleration rather than as Fourier modes, which deflates the value of $\hat \phi$ and inflates the value of $\hat \sigma$. 

The supplementary material provides a detailed breakdown of parameter values for acceleration emission distributions and the empirical joint densities for all models and features.

%%% FoVeDBA %%%
For all models there is no bias in the parameter estimates for the distribution of the Fourier sums ($Z^{*(2)}$). One exception is the CarHHMM, which does not model $Z^{*(2)}$ as an observation at all. The standard error estimates based on the observed Fisher information closely approximate the empirical standard error.
%The distribution of $Z^{*(2)}$ is very different between subdive states 1 and 2, so the signal is therefore very easy for each model to pick up on.
The supplementary material also shows a detailed breakdown of the emission distribution of $Z^{*(2)}$ for all models.

%%% Gamma %%%
Estimates of the coarse-scale probability transition matrix $\Gamma$ for all models (except for the CarHMM-DFT) are very accurate, with empirical standard errors of approximately 0.02 and biases of nearly zero. This is significantly less than the estimate of standard error based on the observed Fisher information, which is about 0.08 for all models.
%likely because the distribution of $\hat \Gamma$ did not converge to a normal distribution in only 100 observed dives. 
For the fine-scale transition matrices $\Gamma^*$, the HHMM-DFT and CarHHMM-DFT both showed practically no bias with standard errors on the order of $10^{-2}$. One notable exception is the standard error of $\hat \Gamma^{*(1)}_{12}$, whose standard error was on the order of $10^{-4}$, much lower than the observed Fisher information would predict. The CarHMM-DFT is mis-specified, so its results cannot be easily interpreted, but $\hat \Gamma^*$ regularly converged to a constant value with a standard error on the order of $10^{-2}$. The CarHHMM consistently overestimated the trace of $\Gamma^{*(i^*)}$. Again, one notable exception is $\hat \Gamma^{*(1)}_{12}$, which had almost no bias and was remarkably consistent. See the supplementary material for a full list of estimates and standard errors.

\fi