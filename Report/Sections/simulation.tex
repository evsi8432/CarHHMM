% !TeX root = ../main.tex

%\section{Simulation Study}

To evaluate the performance of each candidate model when the ground-truth is known, we perform a simulation study based on data generated from the full CarHHMM-DFT. The parameters used to generate the data are loosely based on those estimated in the case study in Section \ref{sec:case_study} (see table \ref{table:emis_dists_CarHHMM-DFT}), with slight modifications made to simplify presentation. For example, we set $\Gamma$ such that the simulated data has approximately equal numbers of short and long dives. This allows meaningful conclusions to be made for both dive types. In addition, the number subdive states is set to $N^*=2$ and $\Ztwo$ is set as a scalar for additional simplicity. Metrics used to evaluate each model include decoding accuracy of hidden states, bias in parameter estimates, standard error of parameter estimates, and fitting times. To assess how accurate each model is when estimating its own uncertainty, we also compare the empirical standard error of each model's parameter estimates with the estimated standard error using the inverse of the observed Fisher information under that model.

\subsection{Data Simulation}

We generate 500 independent data sets from the CarHHMM-DFT. Each data set consists of a sequence of 100 curves which we call a sequence of killer whale dives. Each dive can be one of $N=2$ dive types based on a Markov chain with probability transition matrix
%
$$\Gamma = \begin{pmatrix} 0.5 & 0.5 \\ 0.5 & 0.5 \end{pmatrix}.$$
%
Dive duration is gamma distributed, and the coarse-scale emission parameters $\Theta$ are
$$
    \mu^{(1)} = 20s, \quad \sigma^{(1)} = 5s, \quad
    \mu^{(2)} = 80s, \enspace \text{and} \enspace \sigma^{(2)} = 25s.
$$
%
After calculating the dive durations for all 100 dives in each data set, dive $t$ is broken into a sequence of $T^*_t = \lfloor Y_t/2 \rfloor$ two-second segments which make up the fine-scale hidden Markov model. Each two-second segment is assigned one of $N^*=2$ behaviours according to a fine-scale Markov chain $X^*_t \equiv \left(X^*_{t,1}, \ldots, X^*_{t,T^*_t} \right)$ with probability transition matrices
%
$$\Gamma^{*(1)} = \begin{pmatrix} 0.5 & 0.5 \\ 0.1 & 0.9 \end{pmatrix} \quad \text{ and } \quad \Gamma^{*(2)} = \begin{pmatrix} 0.8 & 0.2 \\ 0.3 & 0.7 \end{pmatrix}.$$ 
%
The observations $Z^*$ are generated using the following parameters:
%
\begin{gather*}
    \mu_A^{*(1)} = 0.0 s, \enspace \sigma_A^{*(1)} = 0.05s, \enspace \phi_A^{*(1)} = 0.99, \\
    %
    \mu_A^{*(2)} = 0.0 s, \enspace \sigma_A^{*(2)} = 0.1s, \enspace \phi_A^{*(2)} = 0.95, \\
    %
    \mu_W^{*(1)} = 10.10, \quad \sigma_W^{*(1)} = 3.18, \\
    %
    \mu_W^{*(2)} = 305.94, \quad \sigma_W^{*(2)} = 17.49.
\end{gather*}
%
Recall that $\Zone$ follows a CarHMM and is Normally distributed while $\Ztwo$ follows an HMM and is Gamma distributed. It is not possible to uniquely recreate the raw accelerometer data $Y^*$ from $Z^*$ alone, but we describe one possible mapping from $Z^*$ to $Y^*$ in the appendix. Figure \ref{fig:sim_data} shows this reconstructed sequence along with one realization of $Z^*$ for five dives of one simulated data set. 

The two dive types differ in that dives of type 1 are much shorter on average than dives of type 2. The two subdive types differ primarily due to $\mu_W^*$ and $\sigma_W^*$, both of which are much higher in subdive state 2 than subdive state 1. This corresponds to much more vigorous and variable periodic behavior in the acceleration data.

All four candidate models (CarHHMM-DFT, HHMM-DFT, CarHHMM, and CarHMM-DFT) are fit to all 500 data sets using the Cedar Compute Canada cluster with 1 CPU and 4 GB of dedicated memory per model.

\subsection{Simulation Results}

As expected, since it is the generating model, the full CarHHMM-DFT is the best-performing model. Using the forward-backward algorithm, the CarHHMM-DFT decodes the correct subdive type given the fine-scale data with an average confidence of $1 - 10^{-12}$ across all simulations. For dive type the average confidence was above 0.9 (see Table \ref{table:accuracy}). All parameter estimates have statistically insignificant biases except for $\hat \sigma$ and $\hat \phi$, whose MLEs are known to be biased. Even still, these biases are the least severe for the CarHHMM-DFT among the four models. The empirical standard error of all parameter estimates ($\hat \Theta$, $\hat \Gamma$, $\hat \Theta^*$, $\hat \Gamma^*$) are well-approximated by the inverse of the observed Fisher information matrix, although the estimated standard errors tend to be slight underestimates of the empirical standard error. See Section S-1.2, tables 2-5 for more information.

The HHMM-DFT performs almost identically to the CarHHMM-DFT in most respects, including its decoding accuracy and parameter bias. However, the HHMM-DFT differed from the CarHHMM-DFT in its estimate of the standard deviation of acceleration, $\hat \sigma_A^*$. For both subdive types, $\hat \sigma_A^*$ greatly overestimates the true standard deviation. The estimated standard errors of $\hat \mu_A^*$ and $\hat \sigma_A^*$ using the observed Fisher information are both much smaller than the empirical standard error (see Section S-1.2, Table 3). This implies that variance can be overestimated and parameter estimates can be too confident when auto-correlation is ignored.

The CarHHMM is the worst-performing model in terms of decoding accuracy, with an average confidence below $0.9$ when determining both dive and subdive types. This result is consistent with expectations because the CarHHMM does not have access to the ``wiggles" of the fine-scale process, which are the most informative observations when determining subdive type. The CarHHMM is also much more likely to mis-classify subdive type 1 than subdive type 2 (see Section S-1.2, Table 1). The CarHHMM is the worst of the four at estimating parameters, and this is in part due to its relatively poor decoding accuracy. $\hat \Theta^{*(2)}$ and $\hat \Gamma^{*(2)}$ are especially poor estimates (see Section S-1.1.3).

Finally, the CarHMM-DFT is comparable to the CarHHMM-DFT in terms of decoding accuracy, parameter bias, and parameter standard error for the fine-scale observations. In addition, the time required to fit the CarHMM-DFT is less than half of that of the other models (see Table \ref{table:accuracy}). However, it lacks any hierarchical structure, so it is unable to estimate dive types. The CarHMM-DFT nonetheless fits a gamma distribution to the dive duration of \textit{all} dives. The parameter estimates for this distribution ($\hat \mu$ and $\hat \sigma$) are highly correlated and $\hat \sigma$ underestimates the true standard deviation of all dive types by $\approx$ 5 seconds. See Figures \ref{fig:acc_coarse} \& \ref{fig:acc_fine} for a visualization of the simulated data set as well as the decoded dive/subdive type probabilities as determined by each model.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% EVERYTHING BELOW HERE IS OLD AND I THINK IT IS BAD. THE STUFF ABOVE IS MUCH BETTER.


\iffalse
%%% Accuracy %%%
Each model was able to decode the fine-scale hidden states of the process almost perfectly except for the CarHHMM, whose accuracy was 89\% (Table \ref{table:accuracy}). The lower accuracy of the CarHHMM (i.e. model without $Z^{*(2)}$)  can be attributed to the higher fine-scale states variation in the distribution of $Z^{*(2)}$ compared to $Z^{*(1)}$. For the coarse-scale hidden states, the CarHMM-DFT lacked a hierarchical structure and could not make coarse-scale predictions. All three other models achieved an accuracy of approximately 90\% (Table \ref{table:accuracy}), with the CarHHMM slightly more likely to categorize a dive as dive type 2 than the other models (Fig ? or Sup Table ? that give quantitative info on this). Figure \ref{fig:acc} shows the decoded state probabilities for both the fine- and coarse- scales for one of the simulation run.

%%% dive duration %%%
For the emission distributions of dive duration, Figure \ref{fig:MLE_dist} shows the empirical joint density of $\hat \mu$ and $\hat \sigma$ for the CarHHMM-DFT.

Estimates of standard error using the observed Fisher information tended to be negatively biased due to correlation between $\hat \mu$ and $\hat \sigma$. In addition, $\hat \sigma$ tends to be an underestimate of $\sigma$ for all models and dive types. This finding is consistent with properties of MLEs for standard deviation, especially with a small sample size. In particular, the CarHMM-DFT model is not well specified one the coarse-scale and severely underestimates $\sigma$. %This is likely due to the fact that dive duration follows a mixture of gammas rather than a gamma distribution, and the CarHMM does not have the machinery to capture this fact. 
A full table of parameter estimates for all models is shown in the supplementary material.


%%% Acceleration %%%
For acceleration ($Z^{*(1)}$), both the CarHMM-DFT and the CarHHMM-DFT regularly converged to the correct parameters with very little standard error. However, the estimated standard error based on the observed Fisher information regularly overestimated the empirical standard error of $\hat \mu$ for both of these models. 
%This likely is due to the very large auto-correlation terms ($\phi^{(1)} = 0.99$ and $\phi^{(2)} = 0.95$) since as $\phi \to 1$, the value of $\mu$ does not matter in the likelihood evaluation as $\phi \to 1$ implies that $\mathbb{E}(Z^{*(1)}_{t,s^*}) = \phi*(Z^{*(1)}_{t,s^*-1}) + (1-\phi)\mu \to Z^{*(1)}_{t,s^*-1}$. 
The HHMM-DFT regularly overestimates the variance $Z^{*(1)}$ since it does not incorporate auto-correlation into the emission distribution of $Z^{*(1)}$. The CarHHMM has large biases in many of its parameter estimates, especially in subdive state 2. 
%because it sees the ``wigliness" of the acceleration data as raw acceleration rather than as Fourier modes, which deflates the value of $\hat \phi$ and inflates the value of $\hat \sigma$. 

The supplementary material provides a detailed breakdown of parameter values for acceleration emission distributions and the empirical joint densities for all models and features.

%%% FoVeDBA %%%
For all models there is no bias in the parameter estimates for the distribution of the Fourier sums ($Z^{*(2)}$). One exception is the CarHHMM, which does not model $Z^{*(2)}$ as an observation at all. The standard error estimates based on the observed Fisher information closely approximate the empirical standard error.
%The distribution of $Z^{*(2)}$ is very different between subdive states 1 and 2, so the signal is therefore very easy for each model to pick up on.
The supplementary material also shows a detailed breakdown of the emission distribution of $Z^{*(2)}$ for all models.

%%% Gamma %%%
Estimates of the coarse-scale probability transition matrix $\Gamma$ for all models (except for the CarHMM-DFT) are very accurate, with empirical standard errors of approximately 0.02 and biases of nearly zero. This is significantly less than the estimate of standard error based on the observed Fisher information, which is about 0.08 for all models.
%likely because the distribution of $\hat \Gamma$ did not converge to a normal distribution in only 100 observed dives. 
For the fine-scale transition matrices $\Gamma^*$, the HHMM-DFT and CarHHMM-DFT both showed practically no bias with standard errors on the order of $10^{-2}$. One notable exception is the standard error of $\hat \Gamma^{*(1)}_{12}$, whose standard error was on the order of $10^{-4}$, much lower than the observed Fisher information would predict. The CarHMM-DFT is mis-specified, so its results cannot be easily interpreted, but $\hat \Gamma^*$ regularly converged to a constant value with a standard error on the order of $10^{-2}$. The CarHHMM consistently overestimated the trace of $\Gamma^{*(i^*)}$. Again, one notable exception is $\hat \Gamma^{*(1)}_{12}$, which had almost no bias and was remarkably consistent. See the supplementary material for a full list of estimates and standard errors.

\fi