% !TeX root = ../main.tex

%\section{Simulation Study}

To compare the performance of the candidate models when the ground-truth is known, we performed a simulation study based on data generated from the full CarHHMM-DFT model. The parameters used to generate the data are loosely based on those learned from the case study in Section \ref{sec:case_study}. The ground-truth parameters differ slightly from those in the case study for primarily pedagogical reasons. For example, we set $\Gamma$ such that the simulated data would contain approximately equal numbers of short and long dives. This allows meaningful conclusions to be made for both dive types. In addition, the number subdive states was set to $N^*=2$ to simplify the analysis of the subdive states, and $\mathbf{Z}^{*(2)}$ was changed from a vector to a scalar for additional simplicity. 

We fit all four candidate models to the data generated from the CarHHMM-DFT in order to analyze the impact of model mis-specification and compare them using several different metrics. These metrics include the decoding accuracy of the dive and subdive types, bias in parameter estimates, standard error of parameter estimates, and fitting times. In addition, we compare the empirical standard error of each model's parameter estimates with the estimated standard error using the observed Fisher information under that model, which allows us to judge how accurate a given model is when estimating its own uncertainty.

\subsection{Data Simulation}

We generated 500 independent data sets from the CarHHMM-DFT. Each data set consisted of a sequence of 100 curves, which we will call a sequence of killer whale dives. Each dive could be one of $N=2$ dive types and the coarse-scale probability transition matrix was set as
%
$$\Gamma = \begin{pmatrix} 0.5 & 0.5 \\ 0.5 & 0.5 \end{pmatrix}.$$
%
Dive duration was gamma distributed, and the coarse-scale emission parameters $\Theta$ were set as
$$
    \mu^{(1)} = 20s, \quad \sigma^{(1)} = 5s, \quad
    \mu^{(2)} = 80s, \enspace \text{and} \enspace \sigma^{(2)} = 25s.
$$
%
After the dive durations were calculated for all 100 dives for each data set using $\Gamma$ and $\Theta$, dive $t$ was broken into a sequence of $T^*_t = \lfloor Y_t/2 \rfloor$ two-second segments, which made up the fine-scale hidden Markov model. The last $Y_t - 2\lfloor Y_t/2 \rfloor$ seconds of the dive were discarded. Each two-second segment was assigned one of $N^*=2$ behaviours according to a fine-scale Markov chain $X^*_t \equiv \left(X^*_{t,1}, \ldots, X^*_{t,T^*_t} \right)$ with probability transition matrices
%
$$\Gamma^{*(1)} = \begin{pmatrix} 0.5 & 0.5 \\ 0.1 & 0.9 \end{pmatrix} \quad \text{ and } \quad \Gamma^{*(2)} = \begin{pmatrix} 0.8 & 0.2 \\ 0.3 & 0.7 \end{pmatrix}.$$ 
%
and the observations $Z^*$ were generated using the following parameters:
%
\begin{gather*}
    \mu_1^{*(1)} = 0.0 s, \enspace \sigma_1^{*(1)} = 0.05s, \enspace \phi_1^{*(1)} = 0.99, \\
    %
    \mu_1^{*(2)} = 0.0 s, \enspace \sigma_1^{*(2)} = 0.1s, \enspace \phi_1^{*(2)} = 0.95, \\
    %
    \mu_2^{*(1)} = 10.10, \quad \sigma_2^{*(1)} = 3.18, \\
    %
    \mu_2^{*(2)} = 305.94, \quad \sigma_2^{*(2)} = 17.49.
\end{gather*}
%
Recall that $Z^{*(1)}$ follows a CarHMM and is Normally distributed while $Z^{*(2)}$ follows an HMM and is Gamma distributed. It is not possible to uniquely recreate the raw fine-scale data $Y^*$ from $Z^*$ alone, but we describe a method to reconstruct one consistent sequence of observations $Y^*$ in the appendix. Figure \ref{fig:sim_data} shows this reconstructed sequence along with $Z^*$ for five dives of one simulated data set.

The two subdive types differ primarily due to $\mu_2^*$ and $\sigma_2^*$, both of which are much higher for subdive type 2. This corresponds to much more vigorous and variable periodic behavior in the acceleration data when the simulated whale is in subdive type 2.

\subsection{Simulation Results}

All four candidate models (CarHHMM-DFT, HHMM-DFT, CarHHMM, and CarHMM-DFT) were fit to all 500 data sets using the Cedar Compute Canada cluster with 1 CPU and 4 GB of dedicated memory per model.

As expected, the full CarHHMM-DFT was the best-performing model. Given the true subdive type of a particular segment $x^*_{t,t^*} = i$, the CarHHMM-DFT would predict the correct subdive type with an average confidence of $1 - 10^{-12}$ across all simulations. For the dive types, this average confidence was above 0.9 (see Table \ref{table:accuracy}). Estimates of hidden states were made using the forward-backward algorithm. All parameter estimates had statistically insignificant biases except for $\hat \sigma$ and $\hat \phi$, whose MLEs are known to be biased. Even still, these biases are the least severe for the CarHHMM-DFT among the four models. The empirical standard error of all parameters estimates ($\hat \Theta$, $\hat \Gamma$, $\hat \Theta^*$, $\hat \Gamma^*$) were well-approximated by the inverse of the observed Fisher information matrix, although the estimated standard errors tended to be slight underestimates of the empirical standard error. See Section S-1.2, tables 2-5 for more information.

The HHMM-DFT performed almost identically to the CarHHMM-DFT in most respects, including its decoding accuracy and parameter bias. The HHMM-DFT differed from the CarHHMM-DFT in its estimate of the standard deviation of acceleration, $\hat \sigma_1^*$. For both subdive states, $\hat \sigma_1^*$ greatly overestimated the true standard deviation. In addition, the empirical standard errors of $\hat \mu_1^*$ and $\hat \sigma_1^*$ were both much larger than the estimates of standard error using the observed Fisher information (see Section S-1.2, Table 3). This implies that parameter estimates can be too confident when auto-correlation is ignored.

The CarHHMM was the worst-performing model in terms of decoding accuracy, with an average confidence of $89 \pm 1\%$ when determining subdive behavior and an average confidence of $87 \pm 11\%$ when determining dive types. It was much more likely to mis-classify subdive behavior 1 than subdive behavior 2 (see Section S-1.2, Table 1). It was also the worst model in terms of parameter estimates, in part due to its relatively poor decoding accuracy. $\hat \Theta^{*(2)}$ and $\hat \Gamma^{*(2)}$ in particular were poor estimates of the true parameters (see Section S-1.1.3).

Finally, the CarHMM-DFT was comparable to the CarHHMM-DFT in terms of decoding accuracy, parameter bias, and parameter standard error for the fine-scale observations. In addition, the time required to fit the CarHMM-DFT was less than half of that of the other models (see Table \ref{table:accuracy}). However, it lacked any hierarchical structure, so it was unable to estimate the coarse-scale dive types. The CarHMM-DFT still did fit a gamma distribution to the dive duration of \textit{all} dives. These parameter estimates $\hat \mu$ and $\hat \sigma$ are highly correlated, and $\hat \sigma$ underestimates the true standard deviation of all dive types by $\approx$ 5 seconds.

See Figure \ref{fig:acc_coarse} \& \ref{fig:acc_fine} for a visualization of the simulated data set as well as the decoded dive/subdive type probabilities as determined by each model.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% EVERYTHING BELOW HERE IS OLD AND I THINK IT IS BAD. THE STUFF ABOVE IS MUCH BETTER.


\iffalse
%%% Accuracy %%%
Each model was able to decode the fine-scale hidden states of the process almost perfectly except for the CarHHMM, whose accuracy was 89\% (Table \ref{table:accuracy}). The lower accuracy of the CarHHMM (i.e. model without $Z^{*(2)}$)  can be attributed to the higher fine-scale states variation in the distribution of $Z^{*(2)}$ compared to $Z^{*(1)}$. For the coarse-scale hidden states, the CarHMM-DFT lacked a hierarchical structure and could not make coarse-scale predictions. All three other models achieved an accuracy of approximately 90\% (Table \ref{table:accuracy}), with the CarHHMM slightly more likely to categorize a dive as dive type 2 than the other models (Fig ? or Sup Table ? that give quantitative info on this). Figure \ref{fig:acc} shows the decoded state probabilities for both the fine- and coarse- scales for one of the simulation run.

%%% dive duration %%%
For the emission distributions of dive duration, Figure \ref{fig:MLE_dist} shows the empirical joint density of $\hat \mu$ and $\hat \sigma$ for the CarHHMM-DFT.

Estimates of standard error using the observed Fisher information tended to be negatively biased due to correlation between $\hat \mu$ and $\hat \sigma$. In addition, $\hat \sigma$ tends to be an underestimate of $\sigma$ for all models and dive types. This finding is consistent with properties of MLEs for standard deviation, especially with a small sample size. In particular, the CarHMM-DFT model is not well specified one the coarse-scale and severely underestimates $\sigma$. %This is likely due to the fact that dive duration follows a mixture of gammas rather than a gamma distribution, and the CarHMM does not have the machinery to capture this fact. 
A full table of parameter estimates for all models is shown in the supplementary material.


%%% Acceleration %%%
For acceleration ($Z^{*(1)}$), both the CarHMM-DFT and the CarHHMM-DFT regularly converged to the correct parameters with very little standard error. However, the estimated standard error based on the observed Fisher information regularly overestimated the empirical standard error of $\hat \mu$ for both of these models. 
%This likely is due to the very large auto-correlation terms ($\phi^{(1)} = 0.99$ and $\phi^{(2)} = 0.95$) since as $\phi \to 1$, the value of $\mu$ does not matter in the likelihood evaluation as $\phi \to 1$ implies that $\mathbb{E}(Z^{*(1)}_{t,s^*}) = \phi*(Z^{*(1)}_{t,s^*-1}) + (1-\phi)\mu \to Z^{*(1)}_{t,s^*-1}$. 
The HHMM-DFT regularly overestimates the variance $Z^{*(1)}$ since it does not incorporate auto-correlation into the emission distribution of $Z^{*(1)}$. The CarHHMM has large biases in many of its parameter estimates, especially in subdive state 2. 
%because it sees the ``wigliness" of the acceleration data as raw acceleration rather than as Fourier modes, which deflates the value of $\hat \phi$ and inflates the value of $\hat \sigma$. 

The supplementary material provides a detailed breakdown of parameter values for acceleration emission distributions and the empirical joint densities for all models and features.

%%% FoVeDBA %%%
For all models there is no bias in the parameter estimates for the distribution of the Fourier sums ($Z^{*(2)}$). One exception is the CarHHMM, which does not model $Z^{*(2)}$ as an observation at all. The standard error estimates based on the observed Fisher information closely approximate the empirical standard error.
%The distribution of $Z^{*(2)}$ is very different between subdive states 1 and 2, so the signal is therefore very easy for each model to pick up on.
The supplementary material also shows a detailed breakdown of the emission distribution of $Z^{*(2)}$ for all models.

%%% Gamma %%%
Estimates of the coarse-scale probability transition matrix $\Gamma$ for all models (except for the CarHMM-DFT) are very accurate, with empirical standard errors of approximately 0.02 and biases of nearly zero. This is significantly less than the estimate of standard error based on the observed Fisher information, which is about 0.08 for all models.
%likely because the distribution of $\hat \Gamma$ did not converge to a normal distribution in only 100 observed dives. 
For the fine-scale transition matrices $\Gamma^*$, the HHMM-DFT and CarHHMM-DFT both showed practically no bias with standard errors on the order of $10^{-2}$. One notable exception is the standard error of $\hat \Gamma^{*(1)}_{12}$, whose standard error was on the order of $10^{-4}$, much lower than the observed Fisher information would predict. The CarHMM-DFT is mis-specified, so its results cannot be easily interpreted, but $\hat \Gamma^*$ regularly converged to a constant value with a standard error on the order of $10^{-2}$. The CarHHMM consistently overestimated the trace of $\Gamma^{*(i^*)}$. Again, one notable exception is $\hat \Gamma^{*(1)}_{12}$, which had almost no bias and was remarkably consistent. See the supplementary material for a full list of estimates and standard errors.

\fi