% !TeX root = ../main.tex

%\section{Simulation Study}

We base the following simulated study on acceleration data of a killer whale dive sequence. The parameters used to generate the data are loosely based on those learned from the case study in section \ref{sec:case_study}. We fit four separate models to the simulated data and compare their performance.

\subsection{Data Simulation}

500 separate sequences of 100 killer whale dives were simulated according to an HMM, where the hidden Markov chain $X$ was set as a collection of dive types and the observations $Y$ were the corresponding dive durations (in seconds). Each dive could be one of $N=2$ dive types, and the duration of dive $t$, $Y_t$, followed a gamma distribution whose parameters $\theta^{(i)}$ depended upon the dive type $X_t = i$. We parameterize the gamma distribution by its mean and variance:
%
$$\Gamma = \begin{pmatrix} 0.5 & 0.5 \\ 0.5 & 0.5 \end{pmatrix}, \qquad \delta =  \begin{pmatrix} 0.5 & 0.5 \end{pmatrix}$$
$$Y_t|X_t \sim \rm{Gamma} $$
\begin{align*}
	&\bbE(Y_t|X_t = 1) = 15 s &\bbE(Y_t|X_t = 2) = 60 s \\
	%
	&\bbV(Y_t|X_t = 1) = 25 s^2 &\bbV(Y_t|X_t = 2) = 100 s^2
\end{align*}
%
Once the dive durations were calculated for all 100 dives, dive $t$ was broken into a sequence of $T^*_t = \lfloor Y_t/2 \rfloor$ two-second segments (the end of the dive sequence was discarded) which made up a second fine-scale hidden Markov model. Each 2-second segment of the dive was assigned one of $N^*=2$ behaviours (active swimming or passive gliding) according to a fine-scale Markov chain $X^*_t \equiv \left(X^*_{t,1}, \ldots, X^*_{t,T^*_t} \right)$, and the probability transition matrices for these fine-scale Markov chains were set as
%
$$\Gamma^{*(1)} = \begin{pmatrix} 0.5 & 0.5 \\ 0.9 & 0.1 \end{pmatrix}, \qquad \Gamma^{*(2)} = \begin{pmatrix} 0.8 & 0.2 \\ 0.3 & 0.7 \end{pmatrix},$$ 
%
where $\Gamma^{*(1)}$ was used for dives where $X_t = 1$ and $\Gamma^{*(2)}$ was used for dives where $X_t = 2$. 

Each two-second sub-dive window had 100 associated acceleration readings, $Y^*_{t,t^*} \equiv \left(Y^*_{t,t^*,1}, \ldots, Y^*_{t,t^*,100}\right)$. To accurately recreate active swimming vs passive gliding on the fine-scale Markov chain, the DFT of each 2-second segment $\hat Y^*_{t,t^*}$ was simulated such that $Z^{*(1)}_{t,t^*}$ and $Z^{*(2)}_{t,t^*}$ (see eqn \ref{eqn:z}) would have the following distributions: 

\begin{gather*}
    \left(Z^{*(1)}_{t,t^*} | Z^{*(1)}_{t,t^*-1}, X^*_{t,t^*} = 1 \right) \sim \mathcal{N} \left(\phi^{*(1)}Z^{*(1)}_{t,t^*-1} + (1-\phi^{*(1)})\mu^{*(1)}, (\sigma^{*(1)})^2 \right) \\
    %
    \left(Z^{*(1)}_{t,t^*} | Z^{*(1)}_{t,t^*-1}, X^*_{t,t^*} = 2 \right) \sim \mathcal{N} \left(\phi^{*(2)}Z^{*(1)}_{t,t^*-1} + (1-\phi^{*(2)})\mu^{*(2)}, (\sigma^{*(2)})^2 \right) \\
    %
    \mu^{*(1)} = 0.0,\enspace \sigma^{*(1)} = 0.05,\enspace \phi^{*(1)} = 0.99 \\
    %
    \mu^{*(2)} = 0.0,\enspace \sigma^{*(2)} = 0.1,\enspace \phi^{*(2)} = 0.95 \\\\
    %
    \left(Z^{*(2)}_{t,t^*} | X^*_{t,t^*} = 1\right) \sim {\rm{Gamma}}\left(\alpha^{*(1)}, \beta^{*(1)} \right) \\
    %
    \left(Z^{*(2)}_{t,t^*} | X^*_{t,t^*} = 2\right) \sim {\rm{Gamma}}\left(\alpha^{*(2)}, \beta^{*(2)} \right) \\
    %
    \alpha^{*(1)} = 10.10, \enspace \enspace \beta^{*(1)} = 1.00 \\
    %
    \alpha^{*(2)} = 305.94, \enspace \enspace \beta^{*(2)} = 1.00
\end{gather*}
%
Sub-dive behavior 1 corresponds to passive gliding while sub-dive behaviour 2 corresponds to active swimming with a dominant frequency of $\frac{1}{2}s^{-1}$. Sub-dive behaviors 1 and 2 are the same for both dive types. See the appendix for more details regarding procedure for simulating $\hat Y^*$ and $Y^*$ such that $Z^*$ has the preceding distribution. (Fig. \ref{fig:sim_data}) shows the first 5 dives of one simulated data set.

\subsection{Model Formulation}
\label{subsec:model_structure}

The building blocks from the previous section were used to build a well-specified model for this simulated data. Specifically, we used a hierarchical HMM where the sequence of dive durations $Y$ was modeled using a simple HMM, and the fine-scale process $Z^*$ was modeled using a HMM-DFT with explicit auto-correlation in $Z^{*(1)}$. Naturally, we refer to this model as the \textit{CarHHMM-DFT}.

On the coarse scale, the dive types follow a Markov chain with $N=2$ possible states and unknown probability transition matrix $\Gamma$. Given the dive type, the duration of a dive follows a gamma distribution which depends upon the dive type and unknown parameters $\Theta = \{\{\mu^{(1)},\sigma^{(1)}\},\{\mu^{(2)},\sigma^{(2)}\}\}$.

On the fine scale, the sub-dive behavior of each two-second window comprises a Markov chain with $N^*=2$ possible states and unknown probability transition matrices $\Gamma^{*(1)}$ and $\Gamma^{*(2)}$, depending upon the dive type. Each two-second window is summarized by the observations $Z^{*(1)}_{t,t^*}$ and $Z^{*(2)}_{t,t^*}$. The distribution of $Z^{*(1)}_{t,t^*}$ is normal and its parameters depend upon the sub-dive behavior $X^*_{t,t^*}$ and $Z^{*(1)}_{t,t^*-1}$. In particular:

$$\mathbb{E}(Z^{*(1)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i^*) = \phi_1^{*(i^*)}z + (1-\phi_1^{*(i^*)}) \mu_1^{*(i^*)}$$
$$\mathbb{V}(Z^{*(1)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i^*) = \left(\sigma_1^{*(i^*)}\right)^2$$
%
The distribution of $Z^{*(2)}_{t,t^*}$ is gamma and its parameters depend upon only $X^*_{t,t^*}$:
%
$$\mathbb{E}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i^*) = \mu_2^{*(i^*)}$$
$$\mathbb{V}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i^*) = (\sigma_2^{*(i^*)})^2$$
%
None of the fine-scale emission distributions depend upon dive type. In total the parameters to learn are
%
\begin{gather*}
    \Gamma, \qquad \Gamma^{*} = \{\Gamma^{*(1)},\Gamma^{*(2)}\} \qquad \text{(probability transition matrices)} \\
    %
    \Theta = \{\{\mu^{(1)},\sigma^{(1)}\},\{\mu^{(2)},\sigma^{(2)}\}\} \qquad \text{(coarse-scale emission parameters)} \\
    %
    \Theta^* = \{\Theta^{*(1)},\Theta^{*(2)}\}  \qquad \text{(fine-scale emission parameters)} \\
    %
    \Theta^{*(i^*)} =  \{\{\mu_1^{*(i^*)},\sigma_1^{*(i^*)},\phi_1^{*(i^*)}\},\{\mu_2^{*(i^*)},\sigma_2^{*(i^*)}\}\} \qquad \text{(}Z^{*(1)} \text{ and } Z^{*(2)} \text{ parameters)}
\end{gather*}
%
The likelihood of this model is still easy to calculate using the forward algorithm, and it can be maximized with respect to the parameters above. See the appendix for details of likelihood evaluation, and (fig. \ref{fig:CarHHMM}) shows the corresponding graphical model.

Including the CarHHMM-DFT described above, four different models were fit to the simulated data sets:
\begin{enumerate}
    \item A \textbf{CarHHMM-DFT} as described above.
    \item An \textbf{HHMM-DFT}, which is similar to the model above, but with no modeled auto-correlation, i.e. $\phi_1^{*(i^*)} = 0$ for $i^* = 1,2$.
    \item A \textbf{CarHHMM}, which is similar to the model above, but without $Z^{*(2)}$ as an observation, i.e $\Theta^{*(i^*)} = \{\mu_1^{(i^*)},\sigma_1^{(i^*)},\phi_1^{(i^*)}\}$, $i^* = 1,2$.
    \item A \textbf{CarHMM-DFT} similar to the CarHHMM-DFT, but with $N=1$ instead of $N=2$, i.e. $\Gamma^* = \{\Gamma^{*(1)}\}$ and $\Theta^* = \{\Theta^{*(1)}\}$. This is equivalent to loosing one level of the hierarchical structure.
\end{enumerate}
%
Each of the last three models leaves out one important aspect of the full CarHHMM-DFT. The CarHMM-DFT lacks a hierarchical structure, the HHMM-DFT is missing auto-correlation within the fine-scale observations, and the CarHHMM does not have access to the Fourier transform sums $(Z^{*(2)})$ as observations. All models were run on the Cedar Compute Canada cluster with 1 CPU and 4 GB of dedicated memory per model.

\subsection{Simulation Results}

%%% Accuracy %%%
Every model was able to decode the fine-scale hidden states of the process almost perfectly except for the \textit{CarHHMM}, which did not have access to the Fourier modes ($Z^{*(2)}$). This is intuitively clear because the distribution of $Z^{*(2)}$ varies between fine-scale states much more than $Z^{*(1)}$. For the coarse-scale hidden states, the CarHMM lacked a hierarchical structure and could not make any predictions at all. The other three models all achieved an accuracy of approximately 90\%, with the CarHHMM slightly more likely to categorize a dive as dive type 2 than the other models. (Fig. \ref{fig:acc}) shows the decoded state probabilities for both the fine- and coarse- scales. (Tbl. \ref{table:accuracy}) also lists more details regarding the accuracy and training times of each model.

%%% dive duration %%%
For the emission distributions of dive duration, estimates of standard error using the observed fisher information tended to be underestimates due to correlation between $\hat \mu$ and $\hat \sigma$. In addition, $\hat \sigma$ tends to underestimate $\sigma$ for all models, which is a finding consistent with properties of MLEs, especially because the sample size for a particular dive type is approximately 50 for each simulation. The CarHMM model in particular severely underestimates $\sigma$. %This is likely due to the fact that dive duration follows a mixture of gammas rather than a gamma distribution, and the CarHMM does not have the machinery to capture this fact. 
A full table of parameter estimates for all models is shown in (table \ref{table:dive_duration}).


%%% Acceleration %%%
For acceleration ($Z^{*(1)}$), both the CarHMM-DFT and the CarHHMM-DFT regularly converged to the correct parameters with very little standard error. However, the fisher standard error regularly overestimated the standard error for $\hat \mu$ for both of these models. 
%This likely is due to the very large auto-correlation terms ($\phi^{(1)} = 0.99$ and $\phi^{(2)} = 0.95$) since as $\phi \to 1$, the value of $\mu$ does not matter in the likelihood evaluation as $\phi \to 1$ implies that $\mathbb{E}(Z^{*(1)}_{t,s^*}) = \phi*(Z^{*(1)}_{t,s^*-1}) + (1-\phi)\mu \to Z^{*(1)}_{t,s^*-1}$. 
The HHMM regularly overestimates the variance $Z^{*(1)}$ since it does not incorporate auto-correlation into the emission distribution of $Z^{*(1)}$, and the CarHHMM has large biases in many of its parameter estimates, especially in sub-dive state 2. 
%because it sees the ``wigliness" of the acceleration data as raw acceleration rather than as Fourier modes, which deflates the value of $\hat \phi$ and inflates the value of $\hat \sigma$. 
See (tbl. \ref{table:acceleration}) for a detailed breakdown of parameter values for acceleration emission distributions.

%%% FoVeDBA %%%
For all models there is no bias in the parameter estimates for the distribution of the Fourier sums ($Z^{*(2)}$). One exception is the CarHHMM, which does not model $Z^{*(2)}$ as an observation. The observed fisher information standard errors are good approximations of the empirical standard error.
%The distribution of $Z^{*(2)}$ is very different between subdive states 1 and 2, so the signal is therefore very easy for each model to pick up on.
(Tbl. \ref{table:FoVeDBA}) shows a detailed breakdown of the emission distribution of $Z^{*(2)}$ for all models.

%%% Gamma %%%

Estimates of the probability transition matrix $\Gamma$ for all models (except for the CarHMM-DFT) are very accurate, with empirical standard errors of approximately 0.02. This is significantly less than the observed fisher information estimate of standard error of approximately 0.08.
%likely because the distribution of $\hat \Gamma$ did not converge to a normal distribution in only 100 observed dives. 
For $\Gamma^*$, the HHMM-DFT and CarHHMM-DFT both showed practically no bias with standard errors on the order of $10^{-2}$. One notable exception is the standard error of $\hat \Gamma^{*(1)}_{12}$, whose standard error was on the order of $10^{-4}$, which is much lower than the observed fisher information predicted. The CarHMM-DFT is mis-specified, so its results cannot be easily interpreted. The CarHHMM consistently underestimated the probability of a hidden state change on the sub-dive behavior. Again, one notable exception is $\hat \Gamma^{*(1)}_{12}$, which had almost no bias and was remarkably consistent. See (Table \ref{table:Gamma}) for a full list of estimates and standard errors.

\textcolor{red}{I also have plots corresponding to each table. For example, I have included figure \ref{fig:MLE_dist} as an example below for the emission distribution of the MLEs for dive duration of the CarHMM. Should I use those instead? But there are just SO many plots (4 models * 3 observations * 2 states = 24 plots)}