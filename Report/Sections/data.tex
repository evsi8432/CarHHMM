% !TeX root = ../main.tex

%\section{Data Collection and Model Construction}

To illustrate the process of constructing a model using the HMM model building blocks, we investigate the dive behavior of a Northern Resident Killer Whale (NRKW) off the coast of British Columbia, Canada, and construct several candidate generative models.

Understanding animal behaviour can be important for conservation efforts, as environmental changes often directly impact behaviour \citep{Sutherland:1998}. NRKW prefer to feed on calorie-rich Chinook salmon (\textit{Oncorhynchus
tshawytscha}) \citep{Ford:2006}, but Chinook occur deeper than other prey, requiring significant energy expenditure from NRKW for predation \citep{Williams:2009,Noren:2011}. It is therefore of interest to determine the energetic expenditure of NRKW to forage for Chinook, especially since many Chinook salmon in the area are either threatened or endangered \citep{Ford:2015}.

Acceleration data can be used to estimate an animal's energy expenditure \citep{Green:2009,Wilson:2019}, but studies suggest that the animal's behavioral state must be taken into account to obtain accurate estimates \citep{Dot:2016}. Therefore, understanding both the behavioral state of the killer whale and the distribution of accelerometer data within each behavioral state is important to understand the true energetic requirements of NRKW.

\subsection{Data collection and preprocessing}

The data used in this study were collected on September 2, 2019 from 12:49 pm to 6:06 pm and consists of depth and acceleration in three orthogonal directions. Observations were collected at a rate of 50 Hz. Tagging the killer whale caused anomalous behavior before 1:20 pm and after 6:00 pm, so observations in these time periods were ignored. In addition, the tagging technology malfunctioned between 2:25pm and 2:37pm as well as between 4:07 and 5:07 pm, so all dives within this time range were ignored as well. A killer whale ``dive" is considered to be any continuous section of data that occurs below 0.5 meters in depth and lasts for at least 10 seconds. Accelerometer and depth data were smoothed by taking a moving average with a window of 1/10th of a second. Data preprocessing was done in part with the \textit{divebomb} package in Python \citep{Nunes:2018}. The preprocessed data contains a total of 267 dives. Figure \ref{fig:data} displays the dive profile and accelerometer data.

Each dive is treated as one curve, and the sequence of dives makes up the coarse-scale process. As such, the coarse-scale observations $Y$ are a time series of dive durations in seconds ($s$) with corresponding hidden dive types $X$. In addition, the fine-scale processes $Y^*$ are the within-dive acceleration data in meters per second squared ($m/s^2$) with corresponding subdive states $X^*$.

\subsection{Model Selection}

A lag plot was constructed to determine where auto-correlation should be incorporated into the model (see Section S-2.1). Prior to fitting the model, the coarse-scale level exhibited no significant amount of auto-correlation and no obvious intricate structure. As such, we selected a simple HMM to model this data. The dive durations $Y_t$ were assumed to follow a gamma distribution with unknown parameters $\{\mu,\sigma\}$:

$$\mathbb{E}(Y_t|X_t = i) = \mu^{(i)}, \qquad \mathbb{V}(Y_t|X_t = i) = \left(\sigma^{(i)}\right)^2.$$

The fine-scale acceleration data exhibited significant sinusoidal behavior; thus the fine-scale observations $Y^*$ were transformed to $Z^*$ using the DFT summary statistics of a two-second sliding window. A two-second window was selected heuristically since it appeared to be the smallest window size that could capture the. ``wiggles" in their entirety. Because the data was collected at the rate of 50 Hz, each two-second window contained a total of 100 raw acceleration readings. The acceleration data here was collected in three dimensions which together represent the complete range of movement of an animal (forward/backward, upward/downward, right/left) and is often collected by these types of tags \citep{Cade:2017,Fehlmann:2017,Wright:2017}. As a result, the transformation from the raw accelerometer data $\mathbf{Y}^*$ to the observation sequence $Z^*$ is calculated as follows:
%
\begin{equation*}
    Z_{t,t^*}^{*(1)} := \text{Re}\left(DFT\{Y^*_{t,t^*}\}(0)\right) \qquad Z_{t,t^*}^{*(2)} := \frac{1}{h}\sum_{k=1}^{\tilde{\omega}}\bigg|\bigg|DFT\{Y^*_{t,t^*}\}(k)\bigg|\bigg|^2
\end{equation*}
%
Each observation is therefore made up of $Z_{t,t^*}^{*(1)}$, a 3-dimensional vector, and $Z_{t,t^*}^{*(2)}$, a scalar. We calculated $Z_t^{*(2)}$ by summing the first 10 Fourier modes, which corresponds to a maximum frequency of $\tilde \omega = 5$ Hz. 

Even after accounting for fine-scale structure in the raw acceleration data, there was still strong auto-correlation within $Z^{*(1)}_{t,t^*}$ prior to fitting the model (section S-2.1). Therefore, a CarHMM was used to model $Z^{*(1)}_{t,t^*}$. In particular, if $X^*_{t,t^*} = i^*$, then we assume $Z^{*(1)}_{t,t^*}$ to be Normally distributed with unknown parameters $\phi_1^{*(i^*)} \in \mathbb{R}$, $\mathbf{\mu}_1^{*(i^*)} \in \mathbb{R}^3$, and $\mathbf{\sigma}_1^{*(i^*)} \in \mathbb{R}^3$.
%
%$$\mathbb{E}(\mathbf{Z}^{*(1)}_{t,t^*}|\mathbf{Z}^{*(1)}_{t,t^*-1} = \mathbf{z}, X^*_{t,t^*} = i) = \phi_1^{*(i)} \mathbf{z} + (1-\phi_1^{*(i)}) \mathbf{\mu}_1^{*(i)},$$
%$$\mathbb{V}(\mathbf{Z}^{*(1)}_{t,t^*}|\mathbf{Z}^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \text{diag}\left[\left(\mathbf{\sigma}_1^{*(i)}\right)^2\right].$$
%

While $Z^{*(2)}$ also exhibits some auto-correlation prior to fitting the model, the relationship is less strong than that of $Z^{*(1)}$, and the biological interpretation of auto-correlation within $Z^{*(2)}$ is less clear. In addition, much of the auto-correlation that \textit{is} evident from the lag plot may be explained by persistence in the subdive type $X^*_{t,t^*}$. Therefore, a simple HMM was used to model $Z^{*(2)}$. In addition, given that $X^*_{t,t^*} = i^*$ the distribution of $Z^{*(2)}_{t,t^*}$ is assumed to be gamma and parameterized by its mean $\mu_2^{*(i^*)}$ and variance $\sigma_2^{*(i^*)}$.
%
%$$\mathbb{E}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \mu_2^{*(i)}$$
%$$\mathbb{V}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \left(\sigma_2^{*(i)}\right)^2.$$
%

We do not use information criteria to select the number of dive types and subdive types since it tends to overestimate the number of states in biological processes \citep{Pohle:2017}. In the particular case of well-separated hidden states, a lag plot will reveal $N$ circular patterns for each dive feature and $N^*$ circular patterns for each subdive feature. This is unfortunately not the case for the killer whale data, but we still consult the lag plots together with a heuristic approach to choose $N = 2$ dive types and $N^* = 3$ subdive behaviors. The absence of a more principled method to select the number of hidden states highlights the importance of model validation techniques in lieu of information criteria (see section \ref{subsec:model_validation}). 

The final model is a hierarchical hidden Markov model with a traditional HMM at the coarse scale. On the fine scale, $Y^*$ is transformed to $Z^*$, $Z^{*(1)}$ is modeled with a CarHMM, and $Z^{*(2)}$ is modeled with an HMM. In addition, we force the fine-scale emission parameters to be shared across coarse-scale hidden states $\left(\theta^{*(1,i^*)} = \ldots = \theta^{*(N,i^*)} \text{ for } i^* = 1,2,3\right)$ to reduce model complexity. This implies that dive types 1 and 2 share subdive states. We refer to this final model as the \textbf{CarHHMM-DFT} since it has elements of all HMM models discussed here. The parameters to estimate are
%
\begin{gather*}
    \Gamma, \qquad \Gamma^{*} = \{\Gamma^{*(1)},\Gamma^{*(2)}\} \qquad \text{(probability transition matrices)}, \\
    %
    \Theta = \{\{\mu^{(1)},\sigma^{(1)}\},\{\mu^{(2)},\sigma^{(2)}\}\} \qquad \text{(coarse-scale emission parameters), and} \\
    %
    \Theta^* = \{\theta^{*(\cdot,1)},\theta^{*(\cdot,2)},\theta^{*(\cdot,3)}\}  \qquad \text{(fine-scale emission parameters), where} \\
    %
    \theta^{*(\cdot,i^*)} =  \{\{\mu_1^{*(\cdot,i^*)},\sigma_1^{*(\cdot,i^*)},\phi_1^{*(\cdot,i^*)}\},\{\mu_2^{*(\cdot,i^*)},\sigma_2^{*(\cdot,i^*)}\}\} \qquad \text{(}Z^{*(1)} \text{ and } Z^{*(2)} \text{ parameters).}
\end{gather*}
%
Remember that $\theta_j^{*(\cdot,i^*)}$ are the parameters describing the distribution of $Z^{*(j)}_{t,t^*}$ when conditioning on $X^*_{t,t^*} = i^*$. The likelihood of this model is easy to calculate using the forward algorithm, and it can be maximized with respect to the parameters above. See the appendix for details of likelihood evaluation. Figure \ref{fig:CarHHMM-DFT} also shows the corresponding graphical model for the CarHHMM-DFT. Additionally, we consider three similar variations for comparison:
\begin{enumerate}
    \item An \textbf{HHMM-DFT}, which models the coarse-scale observations with an HMM and transforms the fine-scale observations using the DFT, but models \textit{both} $Z^{*(1)}$ \textit{and} $Z^{*(2)}$ with a simple HMM rather than a CarHMM.
    \item A \textbf{CarHHMM}, which models the coarse-scale observations with an HMM, transforms the fine-scale observations using the DFT, and models $Z^{*(1)}$ using a CarHMM. However, the Fourier sums $Z^{*(2)}$ are omitted as observations in this model. The Fourier sums $Z^{*(2)}$ describe the ``wiggliness" of the accelerometer data, while $Z^{*(1)}$ is simply the average acceleration over a particular window.
    \item A \textbf{CarHMM-DFT}, which models the coarse-scale observations \textit{as an independent and identically distributed sequence of dives}, transforms the fine-scale observations using the DFT, and models $\mathbf{Z}^{*(1)}$ with a CarHMM and $Z^{*(2)}$ with an HMM. This model assumes that there is only one dive type, so the fine-scale probability transition matrix $\Gamma^*$ is the same for every dive. 
\end{enumerate}
All models have the same emission distributions as the CarHHMM-DFT, when applicable. Each of the three models leaves out one important aspect of the full CarHHMM-DFT. The HHMM-DFT is missing auto-correlation within the fine-scale observations, the CarHHMM does not have access to the Fourier transform sums $(Z^{*(2)})$ as observations, and the CarHMM-DFT lacks a hierarchical structure by only modelling the fine-scale behavior of the whale.