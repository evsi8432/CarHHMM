% !TeX root = ../main.tex

%\section{Data Collection and Model Construction}

To illustrate the process of constructing a model using these building blocks, we analyze the dive behaviour of a northern resident killer whale in Queen Charlotte Sound off the coast of British Columbia, Canada, and construct several candidate models to categorize and describe its diving behaviour.

Understanding animal behaviour is important for conservation efforts, as environmental changes caused by anthropogenic activity can directly impact animal behaviour \citep{Sutherland:1998}. HMMs have been used to understand how diving behaviours of various species are affected by disturbances (e.g., \citet{DeRuiter:2017} and \citet{Isojunno:2017}). For killer whales, we are interested in categorizing different diving behaviours and identifying potential foraging dives. Northern resident killer whales feed almost exclusively on calorie-rich Chinook salmon (\textit{Oncorhynchus tshawytscha}) \citep{Ford:2006}, which typically occur deeper and are less numerous than smaller types of salmon \citep{Ford:2009}. Northern resident killer whales therefore must expend significant amounts of energy to capture Chinook \citep{Williams:2009,Noren:2011,Wright:2017}. 
Acceleration data can be used to estimate an animal's energy expenditure \citep{Green:2009,Wilson:2019}, but the animal's behavioural state must be accounted for in order to obtain accurate estimates \citep{Dot:2016}. Therefore, understanding both the behavioural state of the killer whale and the distribution of acceleration within each behavioural state is needed to determine the true energetic requirements of the animal.

\subsection{Data collection and preprocessing}

The data we use were collected on September 2, 2019 from 12:49 pm to 6:06 pm PDT and consist of depth and acceleration over time. Observations were collected at a rate of 50 Hz using a CATs biologger (Customizable Animal Tracking Solutions, {\em{www.cats.is}}). Acceleration was measured in three dimensions, which together represent the complete range of movement of an animal (forward/backward, upward/downward, and right/left). Tri-axial acceleration readings are common in these types of tags and are often used to infer animal behaviour such as foraging \citep{Cade:2017,Fehlmann:2017,Wright:2017}. The act of attaching and detaching the tag caused anomalous behaviour before 1:20 pm and after 6:00 pm, so observations taken during these time periods are ignored. There were also periods of time when the tag failed to record observations, resulting in data gaps between 2:25 pm and 2:37 pm and between 4:07 pm and 5:07 pm. To preprocess the data, we smooth the depth and acceleration curves by taking a moving average within a window of $1/10^{th}$ of a second. We then define a killer whale ``dive" as any continuous interval of data that occurs below 0.5 meters in depth and lasts for at least 10 seconds. Data are preprocessed in part with the \textit{divebomb} package in Python \citep{Nunes:2018}. The preprocessed data contain a total of 267 dives, all of which are displayed in Figure \ref{fig:data}. Each dive is treated as one curve, and the sequence of dives makes up the coarse-scale process. Specifically, the observed coarse-scale observations $y = \big\{y_1,\ldots,y_{267}\big\}$ make up a sequence of dive durations in seconds, and the coarse-scale hidden states $x = \big\{x_1,\ldots,x_{267}\big\}$ represent the corresponding dive types. For dive $t$, the fine-scale observations are contained in $y^*_{t} = \big\{y^*_{t,1},\ldots,y^*_{t,T^*_t} \big\}$, which is a sequence containing the within-dive acceleration data in units of meters per second squared. The fine-scale hidden states of dive $t$, $x^*_{t} = \big\{x^*_{t,1},\ldots,x^*_{t,T^*_t} \big\}$, represent the subdive behavioural states of the killer whale. The collection of all acceleration data is denoted as $y^* = \big\{y^*_1,\ldots,y^*_{267}\big\}$ and the collection of all unknown subdive behaviours is denoted as $x^* = \big\{x^*_1,\ldots,x^*_{267}\big\}$.

\subsection{Model definition and selection}
\label{subsec:model_selection}

The primary goal of this case study is to jointly estimate the dive types and subdive behaviours of this killer whale, so we only consider models with both a coarse-scale and fine-scale component to describe the kinematic data. Defining a suitable hierarchical model involves selecting an appropriate number of hidden states, model structure, and emission distributions for both the coarse- and fine-scale observations.

We do not use information criteria to select the number of dive types $N$ since these metrics tend to overestimate the number of behavioural states in biological processes \citep{Pohle:2017}. We instead plot the duration of each dive versus the duration of the dive preceding it ($y_t$ versus $y_{t-1}$ for $t \geq 2$). This type of visualization is known as a lag plot. If the emission distributions of the hidden states are well-separated, a lag plot should reveal $N$ distinct patterns, where each pattern corresponds to one dive type \citep{Lawler:2019}. This is unfortunately not the case for our killer whale data, as there is one cluster of data centred at approximately $y_t = y_{t-1} = 30$ seconds. However, longer dives appear to be characterized by bouts of less ``wiggly" behaviour in the acceleration data compared to shorter dives, so we choose $N = 2$ to differentiate these dive types. The absence of a more principled method to select $N$ highlights the importance of model validation techniques in lieu of information criteria (see Section \ref{subsec:model_validation}).
%
Prior to fitting the model, lag plots reveal no significant auto-correlation between dive duration observations (see Figure 1 of of supplement A), and visual inspection shows no obvious complicated dependence. Therefore, we select a simple HMM to model the coarse-scale process since neither a CarHMM nor a moving-window transformation is called for.
%
Given that dive $t$ is of type $i$, we assume that the dive duration $Y_t$ follows a Gamma distribution with unknown parameters $\mu^{(i)}$ and $\sigma^{(i)}$:

\[\mathbb{E}(Y_t|X_t = i) = \mu^{(i)}, \qquad \mathbb{V}(Y_t|X_t = i) = \left(\sigma^{(i)}\right)^2.\]
%
This is consistent with previous studies, including that of \citet{Barajas:2017}. 
%

We then select a model corresponding to the fine-scale observations of acceleration. Similarly to the coarse model, we rely on lag plots and visual inspection to select $N^*=3$ subdive states. Although $N^*$ is selected heuristically, we test the validity of this model in Section \ref{subsec:model_validation}.
%
In contrast to the coarse-scale observations, the fine-scale acceleration data exhibit significant sinusoidal behaviour. Thus, we transform each fine-scale observation sequence $y_t^*$ into $\z_t$ using Equation (\ref{eqn:z}) with a window size of $h=100$ (two seconds) and a maximum frequency of $\tilde{\omega}=10$ (5 Hz). 
We then have that $\z_{t,\tilde t^*} = \{\zone_{t,\tilde t^*},\ztwo_{t,\tilde t^*}\}$, where $\zone_{t,\tilde t^*}$ is a three-dimensional vector of component-wise average acceleration and $\ztwo_{t,\tilde t^*}$ is a scalar describing the ``wiggliness" of a particular window. Even after transforming the raw acceleration data, there is still strong auto-correlation within each component of $\zone_{t,\tilde t^*}$ prior to fitting the model (see Figure 1 of of supplement A). Therefore, we choose a CarHMM as defined in Section 2.2 as the fine-scale model.

We then select the specific emission distributions of $\Z_{t,\tilde t^*}$ for all dive types and subdive states. First, we assume that $\Ztwo_{t,\tilde t^*}$ and all three components of $\Zone_{t,\tilde t^*}$ are independent of one another when conditioned on the dive types and subdive states. To reduce model complexity, we also assume that the three sets of fine-scale emission parameters are shared across the two dive types $\left(\theta^{*(1,i^*)} = \theta^{*(2,i^*)} \equiv \theta^{*(\cdot,i^*)} \text{ for } i^* = 1,2,3\right)$. This implies that the subdive states within dive type 1 have the same interpretation as those within dive type 2.
To specify the emission distribution of $\Zone_{t,\tilde t^*}$, consider the sequence $\{\Zone_{t,1},\ldots,\Zone_{t,T^*_t}\}$ for a particular dive $t$. We assume that each of the three components of this sequence are Normally distributed as in Equation (\ref{eqn:carhmm}) and all components are independent of one another when conditioned on the subdive states $\tilde X^*_t = \{\tilde X^*_{t,1},\ldots,\tilde X^*_{t,\tilde T^*_t}\}$. Each component is assumed to have its own mean and variance parameters, but all components share the same auto-correlation parameter. Thus the distribution of $\Zone_{t,\tilde t^*}$ given $X^*_{t,\tilde t^*} = i^*$ has parameters $\mathbf{\mu}_A^{*(\cdot,i^*)} \in \mathbb{R}^3$, $\mathbf{\sigma}_A^{*(\cdot,i^*)} \in \mathbb{R}^3$, and $\phi_A^{*(\cdot,i^*)} \in [0,1]$.
To specify the emission distribution of $\Ztwo_{t,\tilde t^*}$, we assume that given $\tilde X^*_{t,\tilde t^*} = i^*$, $\Ztwo_{t,\tilde t^*}$ follows a Gamma distribution parameterized by its mean $\mu_W^{*(\cdot,i^*)}$ and standard deviation $\sigma_W^{*(\cdot,i^*)}$. In addition, $\Ztwo_{t,1},\ldots,\Ztwo_{t,T^*_t}$ are assumed to be independent of one another given the subdive state sequence $\big\{\tilde X_{t,1}, \ldots, \tilde X_{t,T_t^*}\big\}$. We do not include $\Ztwo_{t,\tilde t^*-1}$ in the distribution of $\Ztwo_{t,\tilde t^*}$ because the auto-correlation evident from the lag plot is not severe and may be explained by subsequent observations occurring within the same subdive state. 

In total, the parameters to estimate are

\begin{gather*}
    \Gamma, \qquad \Gamma^{*} = \{\Gamma^{*(1)},\Gamma^{*(2)}\} \qquad \text{(probability transition matrices)}, \\
    %
    \theta = \{\mu^{(1)},\sigma^{(1)},\mu^{(2)},\sigma^{(2)}\} \qquad \text{($Y$ emission parameters), and} \\
    %
    \theta^* = \{\theta^{*(\cdot,1)},\theta^{*(\cdot,2)},\theta^{*(\cdot,3)}\}  \qquad \text{($\Z$ emission parameters), where} \\
    %
    \theta^{*(\cdot,i^*)} =  \{\mu_A^{*(\cdot,i^*)},\sigma_A^{*(\cdot,i^*)},\phi_A^{*(\cdot,i^*)},\mu_W^{*(\cdot,i^*)},\sigma_W^{*(\cdot,i^*)}\}.
\end{gather*}
%
Recall that $\theta^{*(\cdot,i^*)}$ is the set of parameters describing the distribution of $\Z_{t,\tilde t^*}$ conditioned on $\tilde X^*_{t,\tilde t^*} = i^*$. 
%
We refer to this final model as the \textbf{CarHHMM-DFT} since it includes a CarHMM, hierarchical HMM, and DFT-based transformation. The likelihood of this model is easily calculated using the forward algorithm and can be maximized with respect to the parameters above (see the appendix for details). Figure \ref{fig:CarHHMM-DFT} shows the dependence structure of the full CarHHMM-DFT.

In addition to the CarHHMM-DFT, we consider three variations for comparison. As in the full model, each of the following models assume that all components of $\Z_{t,\tilde t^*}$ are conditionally independent of one another given the dive types and subdive states:
\begin{enumerate}
    \item An \textbf{HHMM-DFT}, which models the coarse-scale observations with an HMM and transforms the fine-scale observations using Equation (\ref{eqn:z}), but models $\Z_{t,\tilde t^*}$ as emissions from a simple HMM rather than a CarHMM.
    \item A \textbf{CarHHMM}, which models the coarse-scale observations with an HMM, transforms the fine-scale observations using Equation (\ref{eqn:z}), and models $\Zone_{t,\tilde t^*}$ as emissions of a CarHMM. However, the ``wiggliness"  $\Ztwo_{t,\tilde t^*}$ is omitted from this model altogether.
    \item A \textbf{CarHMM-DFT}, which models the coarse-scale observations as an independent and identically distributed sequence of dives, transforms the fine-scale observations using Equation (\ref{eqn:z}), and models $\Z_{t,\tilde t^*}$ as emissions of a CarHMM. This model assumes that there is only one dive type.
\end{enumerate}
%
Each of the three candidate models above leaves out one important aspect of the full CarHHMM-DFT: the HHMM-DFT assumes there is no auto-correlation between fine-scale observations, the CarHHMM does not incorporate ``wiggliness" $\big(\Ztwo_{t,\tilde t^*}\big)$, and the CarHMM-DFT lacks a hierarchical structure and thus does not distinguish between dive types.

%To illustrate an application of this method and compare the candidate models, 
We estimate the parameters of all four models using the data shown in Figure \ref{fig:data} and direct likelihood maximization using the SciPy package in Python \citep{Virtanen:2019}. Each model is fit 100 times using random initializations, and
%Let $\mu_0,\sigma_0$, and $\phi_0$ represent the initial mean, standard deviation, and auto-correlation parameters for a given observation. If the observation is strictly non-negative, then we set $\log(\mu_0) \sim \mathcal{N}(\log(\bar Y),s_{\log})$, $\log(\sigma) \sim \mathcal{N}(s_{\log},1)$, and $\logit(\phi) \sim \mathcal{N}(-1,1)$ where $\bar Y$ represents the sample mean of the observations and $s_{\log}$ represents the sample standard deviation the logarithm of the observations values. If the observation can be any real number, then we set $\mu_0 \sim \mathcal{N}(\bar Y,s)$, $\log(\sigma) \sim \mathcal{N}(s,1)$, and $\logit(\phi) \sim \mathcal{N}(-1,1)$ where $\bar Y$ represents the sample mean and $s$ represents the sample standard deviation of the observations values. 
we keep the parameters estimates corresponding to the maximum likelihood of those 100 optimization routines \citep{Zucchini:2016}. Likelihood maximization is performed on the Cedar Compute Canada cluster with 1 CPU and 8 GB of dedicated memory. Most, but not all, initializations converge to the same parameter estimates, highlighting the need to perform multiple optimizations with a variety of initial guesses. Plots of the likelihood surface near the maximum likelihood estimates are shown in Section 2 of supplement A. 

\subsection{Case study results}

We first report the results from the full CarHHMM-DFT in detail and assess the quality of the fit. We then compare these results with those from the other candidate models.

The coarse-scale parameter estimates suggest that the killer whale has at least two distinct dive behaviours (see Table \ref{table:emis_dists_CarHHMM-DFT} and Figure \ref{fig:emis}). 
Dive type 1 corresponds to shorter, shallower dives which likely reflect resting, travelling, and to a lesser extent searching for prey.
Dive type 2 is longer, deeper, and may be associated with behaviours such as hunting  \citep{Tennessen:2019b}, but it is unclear whether any of the dives in this study are successful foraging dives. No dive in this data set has a maximum depth deeper than 30 meters, and a study by \citet{Wright:2017} of killer whales in Johnstone Strait found that most prey captures occur at depths deeper than 100 meters. However, the killer whale studied here was tagged north of Johnstone Strait in Queen Charlotte Sound, and %researchers 
unpublished data collected by the authors suggest that %significant numbers of 
prey-capture events can occur near the surface. %\citep{Fortune:2020}. 
Dive type 2 could also be associated with behaviours such as socializing that can take place several meters below the surface \citep{Tennessen:2019b}.

The means of ``wiggliness" $\big(\Ztwo_{t,\tilde t^*}\big)$ associated with each subdive state are separated by an order of magnitude (see Table \ref{table:emis_dists_CarHHMM-DFT} and Figure \ref{fig:emis}). 
Subdive state 1 has the smallest mean corresponding to $\Ztwo_{t,\tilde t^*}$ and the smallest standard deviation corresponding to $\Zone_{t,\tilde t^*}$. It also has the highest auto-correlation in $\Zone_{t,\tilde t^*}$. This implies less overall activity and more consistent acceleration compared to the other subdive states. 
Subdive state 2 has a mean ``wiggliness" $\big(\Ztwo_{t,\tilde t^*}\big)$ one order of magnitude higher than subdive state 1 and its acceleration has about twice the standard deviation compared to subdive state 1. The auto-correlation of acceleration is also slightly lower than subdive state 1. We therefore hypothesize that subdive state 2 corresponds to fluking (active swimming), as strong sinusoidal behaviour in acceleration is characteristic of this behaviour in marine mammals \citep{Simon:2012}.
Finally, the mean of $\Ztwo_{t,\tilde t^*}$ and variance of $\Zone_{t,\tilde t^*}$ in subdive state 3 are both much higher than in the other two states, and the auto-correlation of $\Zone_{t,\tilde t^*}$ is also much lower. This corresponds to vigorous swimming activity, especially as the killer whale ends a dive (see Figure \ref{fig:labeled_dives}). 

The estimated probability transition matrices and associated stationary distributions on the coarse scale are

\[\hat \Gamma = \begin{pmatrix} 
0.847 & 0.153 \\
0.914 & 0.086
\end{pmatrix} \text{ and }\]

\[\hat \delta = \begin{pmatrix} 0.857 & 0.143 \end{pmatrix}\]
%
for the transitions between dives. The estimated probability transition matrices and stationary distributions on the fine scale are 

\[\hat \Gamma^{*(1)} = \begin{pmatrix} 
0.745 & 0.253 & 0.002 \\
0.080 & 0.869 & 0.052 \\
0.000 & 0.229 & 0.771
\end{pmatrix}, \qquad 
\hat \Gamma^{*(2)} = \begin{pmatrix} 
0.886 & 0.114 & 0.000 \\
0.150 & 0.815 & 0.036 \\
0.000 & 0.225 & 0.775
\end{pmatrix},\]

\[\hat \delta^{*(1)} = \begin{pmatrix} 0.202 & 0.649 & 0.149 \end{pmatrix}, \enspace \text{and} \enspace \hat \delta^{*(2)} = \begin{pmatrix} 0.531 & 0.405 & 0.064 \end{pmatrix}\]
%
for dive types 1 and 2.
In summary, about 86\% of dives are short dives of type 1, and the whale performs an average of 6.54 short type 1 dives before switching to dive type 2 and an average of 1.09 longer type 2 dives before switching back to dive type 1. This finding is consistent with those of \citet{Tennessen:2019b} and \citet{Williams:2009}, both of whom describe common bouts of short resting dives before a killer whale performs a longer, more energy-intensive deep dive.
Further, this killer whale is in the less active subdive state 1 only 20\% of the time during a dive of type 1 compared to 53\% of the time during a dive of type 2. Less active swimming behaviour is consistent with the need for marine mammals to conserve energy when diving to depth and holding their breath for long periods \citep{Williams:1999,Hastie:2006}. Figure \ref{fig:labeled_dives} shows the decoded dive behaviour of six selected dives, and Section 4 of supplement A also shows the probability of each dive type and subdive state given the data and the fitted model.

\subsection{Model validation}
\label{subsec:model_validation}

We use two visual tools to evaluate the CarHHMM-DFT: pseudoresidual plots and empirical histograms. The pseudoresidual of a coarse-scale observation $y_t$ is equal to $\Phi^{-1} \left(Pr(Y_t < y_t|\{Y_1,\ldots,Y_T,\Z_1,\ldots,\Z_T\}/\{Y_t\}) \right)$ and the pseudoresidual of a fine-scale observation $\z_{t,\tilde t^*}$ is $\Phi^{-1} \left(Pr(\Z_{t,t^*} < \z_{t,\tilde t^*}|\{Y_1,\ldots,Y_T,\Z_1,\ldots,\Z_T\}/\{Y^*_{t,\tilde t}\}) \right)$, where $\Phi$ is the cumulative distribution function of a standard Normal distribution. If the model is correct, then all pseudoresiduals are independent and follow a standard Normal distribution. Histograms of the pseudoresiduals mostly support that the CarHHMM-DFT is well-specified. One exception is $\Ztwo_{t,\tilde t^*}$, whose pseudoresiduals are noticeably right-skewed (see Figure \ref{fig:model_checking}). This implies that the true distribution of $\Ztwo_{t,\tilde t^*}$ may follow a heavier-tailed distribution than the Gamma distribution used in the case study. See Sections 5 through 7 of supplement A for pseudoresidual plots corresponding to all observations and models.

We also plot histograms of dive duration corresponding to each dive type in Figure \ref{fig:model_checking}. Each observation of dive duration is weighted by the estimated probability that it corresponds to a particular dive type as decoded by the %\textit{forward-backward algorithm} \citep{Zucchini:2016}. 
forward-backward algorithm. This procedure results in two histograms -- one corresponding to dive type 1 and another corresponding to dive type 2. Each histogram is plotted together with the corresponding emission distribution estimated by the CarHHMM-DFT. Analogous histograms corresponding to the fine-scale observations are contained in Section 6 and 7 of of supplement A. Our results mostly show that the CarHHMM-DFT explains the data well, but there are some exceptions. In particular, histograms corresponding to subdive state 3 show that $\Zone_{t,\tilde t^*}$ has heavier tails compared to a normal distribution. This indicates the existence of rare events corresponding to exceptionally sudden changes in acceleration of the killer whale. These outliers are potential subjects for future study and may indicate biologically relevant phenomena such as prey capture \citep{Tennessen:2019a}.

\subsection{Comparison with candidate models}

The HHMM-DFT, which ignores auto-correlation in acceleration, decodes dive types and subdive states similarly to the CarHHMM-DFT, but it is less likely to categorize 
any given behaviour as subdive state 3
%the behaviour at the beginning and end of dives as subdive state 3 
(see Figures 11 and 12 of supplement A). In addition, for all three components of each of $\sigma_A^{*(\cdot,1)}$, $\sigma_A^{*(\cdot,2)}$, and $\sigma_A^{*(\cdot,3)}$, the HHMM-DFT produces estimates which are %approximately $50$ to $100$ percent 
significantly larger than those of the CarHHMM-DFT. The estimated uncertainties of the three components of each of $\hat \mu_A^{*(\cdot,1)}$, $\hat \mu_A^{*(\cdot,2)}$, and $\hat \mu_A^{*(\cdot,3)}$ are also less than half of those for the CarHHMM-DFT (see Tables 1 and 2 of of supplement A). This suggests %that including auto-correlation in the model significantly affects parameter estimates, %Further, the pseudoresiduals of the HHMM-DFT are noticeably light-tailed and do not follow a standard normal distribution (see Figure 15 of of supplement A). These findings suggest 
that the HHMM-DFT overlooks some auto-correlation in the data, and that the HHMM-DFT may be overconfident in its parameters estimates compared to the full CarHHMM-DFT.

The CarHHMM does not model the ``wiggliness" of the acceleration data, so it regularly fails to pick up obvious behavioural changes corresponding to the periodicity shown in Figure \ref{fig:labeled_dives} (also see Figure 13 of of supplement A). These results essentially disqualify the CarHHMM as a viable model for this data set. The pseudoresiduals of acceleration are also light-tailed relative to a Normal distribution (see Figure 23 of of supplement A).

Finally, the CarHMM-DFT, which lacks a hierarchical structure, produces fine-scale parameter estimates and subdive state estimates similar to those of the CarHHMM-DFT. However, its lack of hierarchical structure means that it fails to differentiate between short and long dives. This model therefore does not infer the dive-level Markov chain or the relationship between the dive types and subdive states. For example, the CarHMM-DFT does not indicate that the whale is more likely to be in subdive state 1 when engaged in longer dives compared to shorter dives. 

For a more complete set of results for each of the candidate models, see supplement A.