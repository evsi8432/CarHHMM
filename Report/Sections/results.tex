% !TeX root = ../main.tex

%\section{Killer Whale Case Study}

The CarHHMM-DFT was used to analyze dive data from a Northern Resident Killer Whale (NRKW) off the coast of British Columbia, Canada. Acceleration data can be used to approximate an animal's energy expenditure \citep{Green:2009}, but studies suggest that the animal's behavioral state must be taken into account to obtain accurate estimates \citep{Dot:2016}. Therefore, understanding both the behavioral state of the killer whale, as well as the distribution of accelerometer data within each behavioral state, is important to understand the energetic requirements of killer whales. This knowledge can help ecologists understand the animal's energetic requirements and which in turn can help conservation efforts.

\subsection{Data Collection and Preprocessing}

The data used in this study was collected on September 2, 2019 from 12:49 pm to 6:06 pm and consists of depth and acceleration in three orthogonal directions. Observations were collected at a rate of 50 Hz. Tagging the killer whale caused anomalous behavior before 1:20 pm and after 6:00 pm, so observations in this time periods were ignored. In addition, the tagging technology malfunctioned between 2:25pm and 2:37pm as well as between 4:07 and 5:07 pm, so any partially observed dives within this time range were ignored as well. A killer whale ``dive" is considered to be any continuous section of data that occurs below 0.5 meters in depth and lasts for at least 10 seconds. Accelerometer and depth data were smoothed by taking a moving average with a window of 1/10th of a second. Data preprocessing was done in part with the \textit{divebomb} package in Python \citep{Nunes:2018}. After preprocessing the raw data, a total of 267 dives were observed. Figure \ref{fig:data} displays the dive profile and accelerometer data.

\subsection{Model Selection}

We used a hierarchical HHM, where the coarse-scale observations were a time series of dive durations in seconds, and the fine-scale observations were the within-dive acceleration data (Figure \ref{fig:CarHHMM-DFT}). The coarse-scale level is comprised of an HMM with hidden states corresponding to dive types. The dive durations $Y_t$ were assumed to follow a gamma distribution with unknown parameters $\{\mu,\sigma\}$:
$$\mathbb{E}(Y_t|X_t = i) = \mu^{(i)},$$
$$\mathbb{V}(Y_t|X_t = i) = \left(\sigma^{(i)}\right)^2.$$

The fine-scale level model subdive behavior and is comprised of a CarHMM-DFT where auto-correlation is modeled into the distribution of $\mathbf{Z}^{*(1)}$ (the average acceleration with a 2-second window), but not $Z^{*(2)}$ (the ``wiggliness" of the two second window). The acceleration exhibits significant sinusoidal behavior, thus the fine-scale observations $Z^*$ were made up of the DFT summary statistics of a two-second sliding window. Unlike the simulation study, where we had one time series of acceleration data, we have here acceleration data in three dimensions. These three dimensions represent the complete range of movement of an animal (forward/backward, upward/downward, right/left) and is often collected by these types of tags (Citation?). The following two sets of observations $z^*$ were calculated for modeling:
%
$$\mathbf{z}_{t,t^*}^{*(1)} := \mathcal{R}\left(\hat{\mathbf{y}}^{*(0)}_{t,t^*}\right) \qquad z_{t,t^*}^{*(2)} := \frac{1}{100}\sum_{k=1}^{10}||\hat{\mathbf{y}}^{(k)}_{t,t^*}||^2.$$
The observations are therefore made up of $\mathbf{z}_{t,t^*}^{*(1)}$, a 3-dimensional vector, and $z_t^{*(2)}$, a scalar. We calculate $z_t^{*(2)}$ by summing the first 10 Fourier modes, and corresponds to a maximum recorded frequency of $\tilde \omega = 5$ Hz. 

There is strong auto-correlation within $\mathbf{Z}^{*(1)}_{t,t^*}$ for all dimensions (see the supplementary material for a lag plot), thus auto-correlation was directly modeled into the distribution of $\mathbf{Z}^{*(1)}_{t,t^*}$ using a CarHMM. We assumed the error to be Normally distributed with the following parameters:
%
$$\mathbb{E}(\mathbf{Z}^{*(1)}_{t,t^*}|\mathbf{Z}^{*(1)}_{t,t^*-1} = \mathbf{z}, X^*_{t,t^*} = i) = \phi_1^{*(i)} \mathbf{z} + (1-\phi_1^{*(i)}) \mathbf{\mu}_1^{*(i)}$$
$$\mathbb{V}(\mathbf{Z}^{*(1)}_{t,t^*}|\mathbf{Z}^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \text{diag}\left[\left(\mathbf{\sigma}_1^{*(i)}\right)^2\right]$$
%
where $\phi_1^{*(i)} \in \mathbb{R}$, $\mathbf{\mu}_1^{*(i)} \in \mathbb{R}^3$, and $\mathbf{\sigma}_1^{*(i)} \in \mathbb{R}^3$.

While $Z^{*(2)}_{t,t^*}$ also exhibits some auto-correlation, the relationship is less strong, and the biological interpretation of auto-correlation within $Z^{*(2)}_{t,t^*}$ is less clear. Auto-correlation was therefore not incorporated into the emission distribution of $Z^{*(2)}_{t,t^*}$. In particular, the distribution of $Z^{*(2)}_{t,t^*}$ was assumed to be gamma and parameterized by its mean and variance:
%
$$\mathbb{E}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \mu_2^{*(i)}$$
$$\mathbb{V}(Z^{*(2)}_{t,t^*}|Z^{*(1)}_{t,t^*-1} = z,X^*_{t,t^*} = i) = \left(\sigma_2^{*(i)}\right)^2.$$
%
The observations $Z^{*(2)}_{t,t^*}$ and $\mathbf{Z}^{*(1)}_{t,t^*}$ were assumed to be independent of one another when conditioned of the sub-dive state $X_{t,t^*}$.

Information criteria tends to overestimate the number of states in biological processes \citep{Pohle:2017}, so we instead selected $N = 2$ dive types and $N^* = 3$ sub-dive behaviours heuristically. The absence of principled method to select the number of hidden states is a common issue in statistical ecology, so it is important to use model validation techniques in lieu of information criteria (see section \ref{subsec:model_validation}).

The final model is nearly identical to the one from the simulation study, with the exception that the fine-scale Markov chain has three sub-dive behaviors instead of two ($N^* = 3$), and that the observation $\mathbf{z}^{*(1)}_{t,t^*}$ is a 3-dimensional vector rather than a scalar.

\subsection{Results}

The estimates for the emission distribution parameters suggest that this whale has two distinct dive behaviors (Table \ref{table:emis_dists},  figure \ref{fig:coarse_emis}). Dive type 1 corresponds to shorter, shallower dives. Ecologists have attributed a variety of purposes to such short dives, including resting (CITATION, you can ask Ian and Sarah for help here - look at the Tennessen paper with HMM). Dive type 2 is longer and deeper. These types of deep sustained dives have been associated with foraging behaviors in killer whales (CItation Tennessen maybe HMM and the other Tennesen with foraging data).

The three subdive behaviors also appeared distinct, particularly with respect to the fourier sum (Table \ref{table:emis_dists},  Figure  \ref{fig:fine_emis}). Sub-dive type 1 corresponds to gliding and less overall activity compared to the other behavioral states. The mean of $Z^{*(2)}$ in this state is at least an order of magnitude smaller than sub-dive behavioral state 2, the variance of $\mathbf{Z}^{*(1)}$ is smaller than sub-dive behavior 2 for every component, and the auto-correlation of $\mathbf{Z}^{*(1)}$ is higher than every other behavioral state. Sub-dive state 3, on the other hand, corresponds to vigorous swimming activity, as the mean of $Z^{*(2)}$ and variance of $\mathbf{Z}^{*(1)}$ for every component is much higher than every other state. The auto-correlation of $\mathbf{Z}^{*(1)}$ is also much lower in this state, implying more variation in acceleration every 2 seconds. Finally, sub-dive state 2 corresponds to a moderate amount of activity, as almost every parameter estimate is between the other two behavioral states.

The estimated probability transition matrices and associated stationary distributions are
%
$$\hat \Gamma = \begin{pmatrix} 
0.849  &  0.151 \\
0.907  &  0.093
\end{pmatrix},$$
$$\hat \delta = \begin{pmatrix} 0.857 & 0.143 \end{pmatrix},$$
%
$$\hat \Gamma^{*(1)} = \begin{pmatrix} 
0.724 & 0.276 & 0.000 \\
0.057 & 0.887 & 0.056 \\
0.000 & 0.247 & 0.753
\end{pmatrix}, \qquad 
\hat \Gamma^{*(2)} = \begin{pmatrix} 
0.871 & 0.129 & 0.000 \\
0.135 & 0.829 & 0.036 \\
0.000 & 0.246 & 0.754
\end{pmatrix},$$
$$\hat \delta^{*(1)} = \begin{pmatrix} 0.143 & 0.698 & 0.159 \end{pmatrix}, \qquad
\hat \delta^{*(2)} = \begin{pmatrix} 0.476 & 0.456 & 0.067 \end{pmatrix}.$$
%
The coarse-scale stationary distribution indicates that most dives are short type 1 dives. The coarse-scale transition probability matrix further indicates that the whale makes multiple short type 1 dives before doing only one (or a few) long type 2 dive. The fine-scale stationary distributions indicate that this killer whale is more likely to be in the less active sub-dive type 1 when performing long deep dives than when performing short shallow dives. Using less active swimming behavior when diving, and holding breath, for long periods of time has been suggested to be an energy reduction strategy in bottle-nose dolphins \citep{Williams:1999}. Such strategy could explain why sub-dive state 1 makes up 14\% of shallow dives of our killer whale, but it makes up 48\% of deep dives. Figure \ref{fig:labeled_dives} shows the decoded dive behavior of 5 selected dives. The supplementary material also shows the estimated \textit{probability} of each dive time and sub-dive hidden state.

\subsection{Model Validation}
\label{subsec:model_validation}

Two visual tools were used to evaluate this model: pseudo-residuals and empirical histograms. A pseudo-residual of a particular observation is the marginal CDF of an observation conditioned on all other observations under the learned model \citep{Zucchini:2016}. To easily visualize outliers, this pseudo-residual is often passed through the quantile function of the standard Normal distribution. Mathematically, the pseudo-residual of an observation $y_t$ in a traditional HMM is equal to $\Phi^{-1} \left(Pr(Y_t < y_t|\{Y_1,\ldots,Y_T\}/\{Y_t\}) \right)$, where $\Phi$ is the cumulative distribution function of a standard Normal distribution. If the model is correct, then all pseudo-residuals are independent and follow a standard Normal distribution. We find that histograms of the pseudoresiduals of this model mostly support that the model is well-specified. $Z^{*(2)}$ is an exception, as its pseudo-residuals are noticeably right-skewed (Figure \ref{fig:pseudoresids}). This implies that the true distribution of $Z^{*(2)}$ may follow a heavier-tailed distribution than the gamma distribution. 

We also plotted separate histograms of each feature where each observation was weighted by the probability that the whale was in a particular hidden state. This empirical distribution was then plotted over the fitted probability distribution function of that feature and hidden state. If the model is correct, then the histogram of each feature and hidden state should closely resemble its corresponding fitted probability distribution. See Figure \ref{fig:empirical_dist} for an example of the dive duration. Our results mostly support a well-specified model with the exception of $Z^{*(2)}$, which is again right-skewed. In addition, $\mathbf{Z}^{*(1)}$ has heavy tails for sub-dive state 3, indicating the existence of rare events corresponding to exceptionally violent thrashing of the killer whale. These outliers are potential subjects for future study. See the supplementary material for empirical distributions of every feature and every hidden state. 